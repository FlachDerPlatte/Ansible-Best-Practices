
<!doctype html>
<html lang="de" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Best Practices and Style Guide for Ansible Projects">
      
      
      
      <link rel="icon" href="../assets/images/computacenter-logo.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-8.5.10">
    
    
      
        <title>Ansible Best Practices</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.472b142f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.08040f6c.min.css">
        
      
      
  
  
    
    
  
  
  <style>:root{--md-admonition-icon--example:url('data:image/svg+xml;charset=utf-8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.25 12a.75.75 0 0 1-.22.53l-2.75 2.75a.75.75 0 0 1-1.06-1.06L7.44 12 5.22 9.78a.75.75 0 1 1 1.06-1.06l2.75 2.75c.141.14.22.331.22.53zm2 2a.75.75 0 0 0 0 1.5h5a.75.75 0 0 0 0-1.5h-5z"/><path fill-rule="evenodd" d="M0 4.75C0 3.784.784 3 1.75 3h20.5c.966 0 1.75.784 1.75 1.75v14.5A1.75 1.75 0 0 1 22.25 21H1.75A1.75 1.75 0 0 1 0 19.25V4.75zm1.75-.25a.25.25 0 0 0-.25.25v14.5c0 .138.112.25.25.25h20.5a.25.25 0 0 0 .25-.25V4.75a.25.25 0 0 0-.25-.25H1.75z"/></svg>');}</style>


    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/print-site-enum-headings1.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings2.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings3.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings4.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings5.css">
    
      <link rel="stylesheet" href="../css/print-site-enum-headings6.css">
    
      <link rel="stylesheet" href="../css/print-site.css">
    
      <link rel="stylesheet" href="../css/print-site-material.css">
    
      <link rel="stylesheet" href="../assets/stylesheets/snow.css">
    
      <link rel="stylesheet" href="../assets/stylesheets/extra.css">
    
      <link rel="stylesheet" href="../assets/stylesheets/tables.css">
    
    <script>__md_scope=new URL("/",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  
        <script type="text/javascript">
        document.addEventListener('DOMContentLoaded', function () {
            remove_material_navigation();remove_mkdocs_theme_navigation();generate_toc();
        })
        </script>
        </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#" class="md-skip">
          Zum Inhalt
        </a>
      
    </div>
    <div data-md-component="announce">
      
        <aside class="md-banner">
          <div class="md-banner__inner md-grid md-typeset">
            
            
  <!-- Add announcement here, including arbitrary HTML -->
  <!-- <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M1.75 1A1.75 1.75 0 0 0 0 2.75v9.5C0 13.216.784 14 1.75 14H3v1.543a1.457 1.457 0 0 0 2.487 1.03L8.061 14h6.189A1.75 1.75 0 0 0 16 12.25v-9.5A1.75 1.75 0 0 0 14.25 1H1.75zM1.5 2.75a.25.25 0 0 1 .25-.25h12.5a.25.25 0 0 1 .25.25v9.5a.25.25 0 0 1-.25.25h-6.5a.75.75 0 0 0-.53.22L4.5 15.44v-2.19a.75.75 0 0 0-.75-.75h-2a.25.25 0 0 1-.25-.25v-9.5z"/><path d="M22.5 8.75a.25.25 0 0 0-.25-.25h-3.5a.75.75 0 0 1 0-1.5h3.5c.966 0 1.75.784 1.75 1.75v9.5A1.75 1.75 0 0 1 22.25 20H21v1.543a1.457 1.457 0 0 1-2.487 1.03L15.939 20H10.75A1.75 1.75 0 0 1 9 18.25v-1.465a.75.75 0 0 1 1.5 0v1.465c0 .138.112.25.25.25h5.5a.75.75 0 0 1 .53.22l2.72 2.72v-2.19a.75.75 0 0 1 .75-.75h2a.25.25 0 0 0 .25-.25v-9.5z"/></svg></span> &nbsp;Anmerkungen und eure Best Practices sind gern gesehen! -->
  <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill-rule="evenodd" d="M7.875 2.292a.125.125 0 0 0-.032.018A7.24 7.24 0 0 0 4.75 8.25a7.247 7.247 0 0 0 3.654 6.297c.57.327.982.955.941 1.682v.002l-.317 6.058a.75.75 0 1 1-1.498-.078l.317-6.062v-.004c.006-.09-.047-.215-.188-.296A8.747 8.747 0 0 1 3.25 8.25a8.74 8.74 0 0 1 3.732-7.169 1.547 1.547 0 0 1 1.709-.064c.484.292.809.835.809 1.46v4.714a.25.25 0 0 0 .119.213l2.25 1.385c.08.05.182.05.262 0l2.25-1.385a.25.25 0 0 0 .119-.213V2.478c0-.626.325-1.169.81-1.461a1.547 1.547 0 0 1 1.708.064 8.74 8.74 0 0 1 3.732 7.17 8.747 8.747 0 0 1-4.41 7.598c-.14.081-.193.206-.188.296v.004l.318 6.062a.75.75 0 1 1-1.498.078l-.317-6.058v-.002c-.041-.727.37-1.355.94-1.682A7.247 7.247 0 0 0 19.25 8.25a7.24 7.24 0 0 0-3.093-5.94.125.125 0 0 0-.032-.018l-.01-.001c-.003 0-.014 0-.031.01-.036.022-.084.079-.084.177V7.19a1.75 1.75 0 0 1-.833 1.49l-2.25 1.385a1.75 1.75 0 0 1-1.834 0l-2.25-1.384A1.75 1.75 0 0 1 8 7.192V2.477c0-.098-.048-.155-.084-.176a.062.062 0 0 0-.031-.011l-.01.001z"/></svg></span> &nbsp;Work in Progress! <span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.97 8.265a1.45 1.45 0 0 0-.487.57.75.75 0 0 1-1.341-.67c.2-.402.513-.826.997-1.148C10.627 6.69 11.244 6.5 12 6.5c.658 0 1.369.195 1.934.619a2.45 2.45 0 0 1 1.004 2.006c0 1.033-.513 1.72-1.027 2.215-.19.183-.399.358-.579.508l-.147.123a4.329 4.329 0 0 0-.435.409v1.37a.75.75 0 1 1-1.5 0v-1.473c0-.237.067-.504.247-.736.22-.28.486-.517.718-.714l.183-.153.001-.001c.172-.143.324-.27.47-.412.368-.355.569-.676.569-1.136a.953.953 0 0 0-.404-.806C12.766 8.118 12.384 8 12 8c-.494 0-.814.121-1.03.265zM13 17a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/><path fill-rule="evenodd" d="M12 1C5.925 1 1 5.925 1 12s4.925 11 11 11 11-4.925 11-11S18.075 1 12 1zM2.5 12a9.5 9.5 0 1 1 19 0 9.5 9.5 0 0 1-19 0z"/></svg></span> <b>Missing something? Open an issue!</b>

          </div>
          
        </aside>
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Kopfzeile">
    <a href=".." title="Ansible Best Practices" class="md-header__button md-logo" aria-label="Ansible Best Practices" data-md-component="logo">
      
  <img src="../assets/images/computacenter-logo-white.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ansible Best Practices
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9v1Z"/></svg>
            </label>
          
        
          
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Suche" placeholder="Suche" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Suche">
        
        <button type="reset" class="md-search__icon md-icon" title="Zurücksetzen" aria-label="Zurücksetzen" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Suche wird initialisiert
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/TimGrt/Ansible-Best-Practices" title="Zum Repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    TimGrt/Ansible-Best-Practices
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Ansible Best Practices" class="md-nav__button md-logo" aria-label="Ansible Best Practices" data-md-component="logo">
      
  <img src="../assets/images/computacenter-logo-white.png" alt="logo">

    </a>
    Ansible Best Practices
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/TimGrt/Ansible-Best-Practices" title="Zum Repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg>
  </div>
  <div class="md-source__repository">
    TimGrt/Ansible-Best-Practices
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../ansible/">Ansible</a>
          
            <label for="__nav_2">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Ansible" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Ansible
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/installation/" class="md-nav__link">
        Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/project/" class="md-nav__link">
        Project
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/inventory/" class="md-nav__link">
        Inventory
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/variables/" class="md-nav__link">
        Variables
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/playbook/" class="md-nav__link">
        Playbook
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/roles/" class="md-nav__link">
        Roles
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../ansible/tasks/" class="md-nav__link">
        Tasks
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
      
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
            
          
        
          
        
          
        
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../development/">Ansible Development</a>
          
            <label for="__nav_3">
              <span class="md-nav__icon md-icon"></span>
            </label>
          
        </div>
      
      <nav class="md-nav" aria-label="Ansible Development" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Ansible Development
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../development/linting/" class="md-nav__link">
        Linting
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../development/testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../development/extending/" class="md-nav__link">
        Extending
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  

<nav class="md-nav md-nav--secondary" aria-label="On this page">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      On this page
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#" class="md-nav__link">
    1. Overview
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-ansible" class="md-nav__link">
    I. Ansible
  </a>
  
    <nav class="md-nav" aria-label="I. Ansible">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ansible" class="md-nav__link">
    2. Ansible
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-installation" class="md-nav__link">
    3. Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-project" class="md-nav__link">
    4. Project
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-inventory" class="md-nav__link">
    5. Inventory
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-variables" class="md-nav__link">
    6. Variables
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-playbook" class="md-nav__link">
    7. Playbook
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-roles" class="md-nav__link">
    8. Roles
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ansible-tasks" class="md-nav__link">
    9. Tasks
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#section-ansible-development" class="md-nav__link">
    II. Ansible Development
  </a>
  
    <nav class="md-nav" aria-label="II. Ansible Development">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#development" class="md-nav__link">
    10. Development
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-linting" class="md-nav__link">
    11. Linting
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-testing" class="md-nav__link">
    12. Testing
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#development-extending" class="md-nav__link">
    13. Extending
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                




                  


<div id="print-site-page" class="print-site-enumerate-headings print-site-enumerate-figures">
        <section id="print-site-cover-page">
            <div>

    
        <h1>Ansible Best Practices</h1>
    

</div>

<p>
    <img src="../assets/computacenter.png" width=500/>
</p>


<p>
    Best Practices and Style Guide for Ansible Projects
</p>



<p>
    <em>Copyright &copy; Computacenter 2022</em>
</p>

        </section>
        
        <div id="print-site-banner">
            <p>
    <b><em>This box will disappear when printing!</em></b>
</p>
<p>This page has combined all site pages into one. This cover page and a table of contents will be added.</p>
<p>You can export to PDF using <b>File > Print > Save as PDF</b> (or use <b>Ctrl-P</b> and set to <b>Save as PDF</b>).</p>
<p>See also <a href="https://timvink.github.io/mkdocs-print-site-plugin/how-to/export-PDF.html">Export to PDF</a>.</p>
        </div>
        
        <section class="print-page">
            <div id="print-page-toc" data-toc-depth="3">
                <nav role='navigation' class='print-page-toc-nav'>
                <h1 class='print-page-toc-title'>Table of Contents</h1>
                </nav>
            </div>
        </section>
        <section class="print-page" id="index"><h1 id="index-best-practices">Best Practices</h1>
<p>This document aims to gather good and best practices from Ansible practitioners and projects at Computacenter. It strives to give all Ansible users a guideline from which to start their automation journey in good conditions.</p>
<figure>
<p><img alt="CC Logo" src="../assets/images/computacenter.png#only-light" width="500" />
  <img alt="CC Logo" src="../assets/images/computacenter-white.png#only-dark" width="500" />
  </p>
<figcaption></figcaption>
</figure>
<p>Ansible is simple, flexible, and powerful. Like any powerful tool, there are many ways to use it, some better than others.</p>
<p>Those are <strong>opinionated</strong> guidelines based on the experience of many projects. They are not meant to be followed blindly if they don’t fit the reader’s specific use case or needs. Take them as an inspiration and adjust them to your needs, still let us know your good and best practices, we all can learn.</p>
<div class="admonition tip">
<p class="admonition-title">Versioning</p>
<p>This guide is updated constantly, last update on <strong><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">13. Dezember 2022</span></strong>.</p>
</div></section>
                        <h1 class='nav-section-title' id='section-ansible'>
                            Ansible <a class='headerlink' href='#section-ansible' title='Permanent link'>↵</a>
                        </h1>
                        <section class="print-page" id="ansible"><h1 id="ansible-ansible">Ansible</h1>
<p>This topic is split into seven main sections, each section covers a different aspect of automation using Ansible.</p>
<ul>
<li><a href="#ansible-installation"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.429 1.525a6.593 6.593 0 0 1 1.142 0c.036.003.108.036.137.146l.289 1.105c.147.56.55.967.997 1.189.174.086.341.183.501.29.417.278.97.423 1.53.27l1.102-.303c.11-.03.175.016.195.046.219.31.41.641.573.989.014.031.022.11-.059.19l-.815.806c-.411.406-.562.957-.53 1.456a4.588 4.588 0 0 1 0 .582c-.032.499.119 1.05.53 1.456l.815.806c.08.08.073.159.059.19a6.494 6.494 0 0 1-.573.99c-.02.029-.086.074-.195.045l-1.103-.303c-.559-.153-1.112-.008-1.529.27-.16.107-.327.204-.5.29-.449.222-.851.628-.998 1.189l-.289 1.105c-.029.11-.101.143-.137.146a6.613 6.613 0 0 1-1.142 0c-.036-.003-.108-.037-.137-.146l-.289-1.105c-.147-.56-.55-.967-.997-1.189a4.502 4.502 0 0 1-.501-.29c-.417-.278-.97-.423-1.53-.27l-1.102.303c-.11.03-.175-.016-.195-.046a6.492 6.492 0 0 1-.573-.989c-.014-.031-.022-.11.059-.19l.815-.806c.411-.406.562-.957.53-1.456a4.587 4.587 0 0 1 0-.582c.032-.499-.119-1.05-.53-1.456l-.815-.806c-.08-.08-.073-.159-.059-.19a6.44 6.44 0 0 1 .573-.99c.02-.029.086-.075.195-.045l1.103.303c.559.153 1.112.008 1.529-.27.16-.107.327-.204.5-.29.449-.222.851-.628.998-1.189l.289-1.105c.029-.11.101-.143.137-.146zM8 0c-.236 0-.47.01-.701.03-.743.065-1.29.615-1.458 1.261l-.29 1.106c-.017.066-.078.158-.211.224a5.994 5.994 0 0 0-.668.386c-.123.082-.233.09-.3.071L3.27 2.776c-.644-.177-1.392.02-1.82.63a7.977 7.977 0 0 0-.704 1.217c-.315.675-.111 1.422.363 1.891l.815.806c.05.048.098.147.088.294a6.084 6.084 0 0 0 0 .772c.01.147-.038.246-.088.294l-.815.806c-.474.469-.678 1.216-.363 1.891.2.428.436.835.704 1.218.428.609 1.176.806 1.82.63l1.103-.303c.066-.019.176-.011.299.071.213.143.436.272.668.386.133.066.194.158.212.224l.289 1.106c.169.646.715 1.196 1.458 1.26a8.094 8.094 0 0 0 1.402 0c.743-.064 1.29-.614 1.458-1.26l.29-1.106c.017-.066.078-.158.211-.224a5.98 5.98 0 0 0 .668-.386c.123-.082.233-.09.3-.071l1.102.302c.644.177 1.392-.02 1.82-.63.268-.382.505-.789.704-1.217.315-.675.111-1.422-.364-1.891l-.814-.806c-.05-.048-.098-.147-.088-.294a6.1 6.1 0 0 0 0-.772c-.01-.147.039-.246.088-.294l.814-.806c.475-.469.679-1.216.364-1.891a7.992 7.992 0 0 0-.704-1.218c-.428-.609-1.176-.806-1.82-.63l-1.103.303c-.066.019-.176.011-.299-.071a5.991 5.991 0 0 0-.668-.386c-.133-.066-.194-.158-.212-.224L10.16 1.29C9.99.645 9.444.095 8.701.031A8.094 8.094 0 0 0 8 0zm1.5 8a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zM11 8a3 3 0 1 1-6 0 3 3 0 0 1 6 0z"/></svg></span> &nbsp; Installation</a> - How to run Ansible, from present to future</li>
<li><a href="#ansible-project"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2 2.5A2.5 2.5 0 0 1 4.5 0h8.75a.75.75 0 0 1 .75.75v12.5a.75.75 0 0 1-.75.75h-2.5a.75.75 0 1 1 0-1.5h1.75v-2h-8a1 1 0 0 0-.714 1.7.75.75 0 0 1-1.072 1.05A2.495 2.495 0 0 1 2 11.5v-9zm10.5-1V9h-8c-.356 0-.694.074-1 .208V2.5a1 1 0 0 1 1-1h8zM5 12.25v3.25a.25.25 0 0 0 .4.2l1.45-1.087a.25.25 0 0 1 .3 0L8.6 15.7a.25.25 0 0 0 .4-.2v-3.25a.25.25 0 0 0-.25-.25h-3.5a.25.25 0 0 0-.25.25z"/></svg></span> &nbsp; Project</a> - Your Ansible project, version control, dependencies, syntax </li>
<li><a href="#ansible-inventory"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.75 1A1.75 1.75 0 0 0 0 2.75v4c0 .372.116.717.314 1a1.742 1.742 0 0 0-.314 1v4c0 .966.784 1.75 1.75 1.75h12.5A1.75 1.75 0 0 0 16 12.75v-4c0-.372-.116-.717-.314-1 .198-.283.314-.628.314-1v-4A1.75 1.75 0 0 0 14.25 1H1.75zm0 7.5a.25.25 0 0 0-.25.25v4c0 .138.112.25.25.25h12.5a.25.25 0 0 0 .25-.25v-4a.25.25 0 0 0-.25-.25H1.75zM1.5 2.75a.25.25 0 0 1 .25-.25h12.5a.25.25 0 0 1 .25.25v4a.25.25 0 0 1-.25.25H1.75a.25.25 0 0 1-.25-.25v-4zm5.5 2A.75.75 0 0 1 7.75 4h4.5a.75.75 0 0 1 0 1.5h-4.5A.75.75 0 0 1 7 4.75zM7.75 10a.75.75 0 0 0 0 1.5h4.5a.75.75 0 0 0 0-1.5h-4.5zM3 4.75A.75.75 0 0 1 3.75 4h.5a.75.75 0 0 1 0 1.5h-.5A.75.75 0 0 1 3 4.75zM3.75 10a.75.75 0 0 0 0 1.5h.5a.75.75 0 0 0 0-1.5h-.5z"/></svg></span> &nbsp; Inventory</a> - How to define your inventory and target hosts</li>
<li><a href="#ansible-variables"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.75 2.5a.75.75 0 0 0 0 1.5h6.5a.75.75 0 0 0 0-1.5h-6.5zm4 5a.75.75 0 0 0 0 1.5h7.5a.75.75 0 0 0 0-1.5h-7.5zm0 5a.75.75 0 0 0 0 1.5h7.5a.75.75 0 0 0 0-1.5h-7.5zM3 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-1 6a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/><path d="M13.314 4.918 11.07 2.417A.25.25 0 0 1 11.256 2h4.488a.25.25 0 0 1 .186.417l-2.244 2.5a.25.25 0 0 1-.372 0z"/></svg></span> &nbsp; Variables</a> - All about variables, where to store them, naming conventions and encryption</li>
<li><a href="#ansible-playbook"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M14.064 0a8.75 8.75 0 0 0-6.187 2.563l-.459.458c-.314.314-.616.641-.904.979H3.31a1.75 1.75 0 0 0-1.49.833L.11 7.607a.75.75 0 0 0 .418 1.11l3.102.954c.037.051.079.1.124.145l2.429 2.428c.046.046.094.088.145.125l.954 3.102a.75.75 0 0 0 1.11.418l2.774-1.707a1.75 1.75 0 0 0 .833-1.49V9.485c.338-.288.665-.59.979-.904l.458-.459A8.75 8.75 0 0 0 16 1.936V1.75A1.75 1.75 0 0 0 14.25 0h-.186zM10.5 10.625c-.088.06-.177.118-.266.175l-2.35 1.521.548 1.783 1.949-1.2a.25.25 0 0 0 .119-.213v-2.066zM3.678 8.116 5.2 5.766c.058-.09.117-.178.176-.266H3.309a.25.25 0 0 0-.213.119l-1.2 1.95 1.782.547zm5.26-4.493A7.25 7.25 0 0 1 14.063 1.5h.186a.25.25 0 0 1 .25.25v.186a7.25 7.25 0 0 1-2.123 5.127l-.459.458a15.21 15.21 0 0 1-2.499 2.02l-2.317 1.5-2.143-2.143 1.5-2.317a15.25 15.25 0 0 1 2.02-2.5l.458-.458h.002zM12 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-8.44 9.56a1.5 1.5 0 1 0-2.12-2.12c-.734.73-1.047 2.332-1.15 3.003a.23.23 0 0 0 .265.265c.671-.103 2.273-.416 3.005-1.148z"/></svg></span> &nbsp; Playbook</a> - Structure your automation, how to separate playbooks and plays</li>
<li><a href="#ansible-roles"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M7.122.392a1.75 1.75 0 0 1 1.756 0l5.003 2.902c.83.481.83 1.68 0 2.162L8.878 8.358a1.75 1.75 0 0 1-1.756 0L2.119 5.456a1.25 1.25 0 0 1 0-2.162L7.122.392zM8.125 1.69a.25.25 0 0 0-.25 0l-4.63 2.685 4.63 2.685a.25.25 0 0 0 .25 0l4.63-2.685-4.63-2.685zM1.601 7.789a.75.75 0 0 1 1.025-.273l5.249 3.044a.25.25 0 0 0 .25 0l5.249-3.044a.75.75 0 0 1 .752 1.298l-5.248 3.044a1.75 1.75 0 0 1-1.756 0L1.874 8.814A.75.75 0 0 1 1.6 7.789zm0 3.5a.75.75 0 0 1 1.025-.273l5.249 3.044a.25.25 0 0 0 .25 0l5.249-3.044a.75.75 0 0 1 .752 1.298l-5.248 3.044a1.75 1.75 0 0 1-1.756 0l-5.248-3.044a.75.75 0 0 1-.273-1.025z"/></svg></span> &nbsp; Roles</a> - A best practice in itself, including how to create and fill the role folder</li>
<li><a href="#ansible-tasks"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M2.003 2.5a.5.5 0 0 0-.723-.447l-1.003.5a.5.5 0 0 0 .446.895l.28-.14V6H.5a.5.5 0 0 0 0 1h2.006a.5.5 0 1 0 0-1h-.503V2.5zM5 3.25a.75.75 0 0 1 .75-.75h8.5a.75.75 0 0 1 0 1.5h-8.5A.75.75 0 0 1 5 3.25zm0 5a.75.75 0 0 1 .75-.75h8.5a.75.75 0 0 1 0 1.5h-8.5A.75.75 0 0 1 5 8.25zm0 5a.75.75 0 0 1 .75-.75h8.5a.75.75 0 0 1 0 1.5h-8.5a.75.75 0 0 1-.75-.75zM.924 10.32l.003-.004a.851.851 0 0 1 .144-.153A.66.66 0 0 1 1.5 10c.195 0 .306.068.374.146a.57.57 0 0 1 .128.376c0 .453-.269.682-.8 1.078l-.035.025C.692 11.98 0 12.495 0 13.5a.5.5 0 0 0 .5.5h2.003a.5.5 0 0 0 0-1H1.146c.132-.197.351-.372.654-.597l.047-.035c.47-.35 1.156-.858 1.156-1.845 0-.365-.118-.744-.377-1.038-.268-.303-.658-.484-1.126-.484-.48 0-.84.202-1.068.392a1.858 1.858 0 0 0-.348.384l-.007.011-.002.004-.001.002-.001.001a.5.5 0 0 0 .851.525zM.5 10.055l-.427-.26.427.26z"/></svg></span> &nbsp; Tasks</a> - Everything about tasks, module usage, tags, loops and filters</li>
</ul></section><section class="print-page" id="ansible-installation"><h1 id="ansible-installation-installation">Installation</h1>
<h2 id="ansible-installation-_1"></h2>
<p>The latest version can only be obtained via the Python package manager, the <em>ansible-core</em> package contains the binaries and 69 standard modules.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-installation-__codelineno-0-1"></a>pip3 install ansible-core
</code></pre></div>
<p>If more special modules are needed, the complete <em>ansible</em> package can be installed, this corresponds to the "old" installation method (<em>batteries included</em>).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-installation-__codelineno-1-1"></a>pip3 install ansible
</code></pre></div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It makes sense to install only the <em>ansible-core</em> package. Afterwards, install the few collections necessary for your project via <code>ansible-galaxy</code>. 
This way you have an up-to-date, lean installation without unnecessary modules and plugins. </p>
</div>
<p>Thereby the <a href="#ansible-project-collections">chapter Project &gt; Collections</a> is to be considered. If a container runtime is available, the complete installation can also be bundled in a container image (so-called <em>Execution Environment</em>).</p>
<h2 id="ansible-installation-execution-environments">Execution environments</h2>
<p>Execution Environments are container images that serve as Ansible control nodes.</p>
<h3 id="ansible-installation-ansible-builder">Ansible Builder</h3>
<p>Ansible Builder is a tool that aids in the creation of Ansible Execution Environments. It does this by using the dependency information defined in various Ansible Content Collections, as well as by the user. Ansible Builder will produce a directory that acts as the build context for the container image build, which will contain the <em>Containerfile</em> (<em>Dockerfile</em>), along with any other files that need to be added to the image. There is no need to write a single line of Dockerfile, which makes it easy to build and use Execution Environments (EE).</p>
<p>To build an EE, install <code>ansible-builder</code> from the Python Package Manager:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-installation-__codelineno-2-1"></a>pip3 install ansible-builder
</code></pre></div>
<p>Define at least the definition file for the Execution Environment and other files, depending on your use-case.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="ansible-installation-__tabbed_1_1" name="ansible-installation-__tabbed_1" type="radio" /><input id="ansible-installation-__tabbed_1_2" name="ansible-installation-__tabbed_1" type="radio" /><input id="ansible-installation-__tabbed_1_3" name="ansible-installation-__tabbed_1" type="radio" /><input id="ansible-installation-__tabbed_1_4" name="ansible-installation-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="ansible-installation-__tabbed_1_1">EE definition file</label><label for="ansible-installation-__tabbed_1_2">Collection Dependencies</label><label for="ansible-installation-__tabbed_1_3">Python Dependencies</label><label for="ansible-installation-__tabbed_1_4">Cross-Platform requirements</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">execution-environment.yml</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#ansible-installation-__codelineno-3-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#ansible-installation-__codelineno-3-2"></a><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w"></span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#ansible-installation-__codelineno-3-3"></a>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#ansible-installation-__codelineno-3-4"></a><span class="nt">build_arg_defaults</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#ansible-installation-__codelineno-3-5"></a><span class="w">  </span><span class="nt">EE_BASE_IMAGE</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;quay.io/ansible/ansible-runner:latest&#39;</span><span class="w"></span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#ansible-installation-__codelineno-3-6"></a>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#ansible-installation-__codelineno-3-7"></a><span class="nt">ansible_config</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;ansible.cfg&#39;</span><span class="w"></span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#ansible-installation-__codelineno-3-8"></a>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#ansible-installation-__codelineno-3-9"></a><span class="nt">dependencies</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#ansible-installation-__codelineno-3-10"></a><span class="w">  </span><span class="nt">galaxy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">requirements.yml</span><span class="w"></span>
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#ansible-installation-__codelineno-3-11"></a><span class="w">  </span><span class="nt">python</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">requirements.txt</span><span class="w"></span>
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#ansible-installation-__codelineno-3-12"></a><span class="w">  </span><span class="nt">system</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bindep.txt</span><span class="w"></span>
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#ansible-installation-__codelineno-3-13"></a>
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#ansible-installation-__codelineno-3-14"></a><span class="nt">additional_build_steps</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#ansible-installation-__codelineno-3-15"></a><span class="w">  </span><span class="nt">prepend</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"></span>
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#ansible-installation-__codelineno-3-16"></a><span class="w">    </span><span class="no">RUN pip3 install --upgrade pip setuptools</span><span class="w"></span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">requirements.yml</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#ansible-installation-__codelineno-4-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#ansible-installation-__codelineno-4-2"></a><span class="nt">collections</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#ansible-installation-__codelineno-4-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">redhat.openshift</span><span class="w"></span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">requirements.txt</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#ansible-installation-__codelineno-5-1"></a>awxkit&gt;=13.0.0
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#ansible-installation-__codelineno-5-2"></a>boto&gt;=2.49.0
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#ansible-installation-__codelineno-5-3"></a>botocore&gt;=1.12.249
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#ansible-installation-__codelineno-5-4"></a>boto3&gt;=1.9.249
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#ansible-installation-__codelineno-5-5"></a>openshift&gt;=0.6.2
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#ansible-installation-__codelineno-5-6"></a>requests-oauthlib 
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">bindep.txt</p>
<p>If there are RPMS necessary, put them here.
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#ansible-installation-__codelineno-6-1"></a>subversion [platform:rpm]
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#ansible-installation-__codelineno-6-2"></a>subversion [platform:dpkg]
</code></pre></div></p>
</div>
</div>
</div>
</div>
<p>For more information, go to the <a href="https://ansible-builder.readthedocs.io/en/stable/" target="_blank">Ansible Builder Documenction</a></p>
<p>To build the EE, run this command (assuming you have Docker installed, by default Podman is used):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#ansible-installation-__codelineno-7-1"></a>ansible-builder build --tag<span class="o">=</span>demo/openshift-ee --container-runtime<span class="o">=</span>docker
</code></pre></div>
<p>The resulting container images can be viewed with the <code>docker images</code> command:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#ansible-installation-__codelineno-8-1"></a>$ docker images
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#ansible-installation-__codelineno-8-2"></a>REPOSITORY                        TAG       IMAGE ID       CREATED              SIZE
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#ansible-installation-__codelineno-8-3"></a>demo/openshift-ee                 latest    2ea9d5d7b185   <span class="m">10</span> seconds ago       <span class="m">1</span>.14GB
</code></pre></div>
<h3 id="ansible-installation-ansible-runner">Ansible Runner</h3>
<p>Using the EE requires a binary which can make use of the Container images, it is not possible to run them with the <code>ansible-playbook</code> binary. You have to use (and install) either the <code>ansible-navigator</code> or the <code>ansible-runner</code> binary.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#ansible-installation-__codelineno-9-1"></a>pip3 install ansible-runner
</code></pre></div>
<p>To use the Ansible from the container image, e.g. run this command which executes an ad hoc command (<em>setup</em> module) against localhost:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#ansible-installation-__codelineno-10-1"></a>ansible-runner run --container-image demo/openshift-ee /tmp -m setup --hosts localhost
</code></pre></div>
<p>Most parameters should be self-explanatory:</p>
<ul>
<li><em>run</em> - Run ansible-runner in the foreground</li>
<li><em>--container-image demo/openshift</em> - Container image to use when running an ansible task</li>
<li><em>/tmp</em> - base directory containing the ansible-runner metadata (project, inventory, env, etc)</li>
<li><em>-m setup</em> - Module to execute</li>
<li><em>--hosts localhost</em> - set of hosts to execute against (here only localhost)</li>
</ul>
<p>The output looks like expected:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#ansible-installation-__codelineno-11-1"></a>$ ansible-runner run --container-image demo/openshift-ee /tmp -m setup --hosts localhost
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#ansible-installation-__codelineno-11-2"></a><span class="o">[</span>WARNING<span class="o">]</span>: No inventory was parsed, only implicit localhost is available
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#ansible-installation-__codelineno-11-3"></a>localhost <span class="p">|</span> <span class="nv">SUCCESS</span> <span class="o">=</span>&gt; <span class="o">{</span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#ansible-installation-__codelineno-11-4"></a>    <span class="s2">&quot;ansible_facts&quot;</span>: <span class="o">{</span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#ansible-installation-__codelineno-11-5"></a>        <span class="s2">&quot;ansible_all_ipv4_addresses&quot;</span>: <span class="o">[</span>
<a id="__codelineno-11-6" name="__codelineno-11-6" href="#ansible-installation-__codelineno-11-6"></a>            <span class="s2">&quot;192.168.178.114&quot;</span>,
<a id="__codelineno-11-7" name="__codelineno-11-7" href="#ansible-installation-__codelineno-11-7"></a>            <span class="s2">&quot;172.17.0.1&quot;</span>
<a id="__codelineno-11-8" name="__codelineno-11-8" href="#ansible-installation-__codelineno-11-8"></a>        <span class="o">]</span>,
<a id="__codelineno-11-9" name="__codelineno-11-9" href="#ansible-installation-__codelineno-11-9"></a>        <span class="s2">&quot;ansible_all_ipv6_addresses&quot;</span>: <span class="o">[</span>
<a id="__codelineno-11-10" name="__codelineno-11-10" href="#ansible-installation-__codelineno-11-10"></a>            <span class="s2">&quot;2001:9e8:4a14:2401:a00:27ff:febf:4207&quot;</span>,
<a id="__codelineno-11-11" name="__codelineno-11-11" href="#ansible-installation-__codelineno-11-11"></a>            <span class="s2">&quot;fe80::a00:27ff:febf:4207&quot;</span>,
<a id="__codelineno-11-12" name="__codelineno-11-12" href="#ansible-installation-__codelineno-11-12"></a>            <span class="s2">&quot;fe80::42:9eff:fef9:df59&quot;</span>
<a id="__codelineno-11-13" name="__codelineno-11-13" href="#ansible-installation-__codelineno-11-13"></a>        <span class="o">]</span>,
<a id="__codelineno-11-14" name="__codelineno-11-14" href="#ansible-installation-__codelineno-11-14"></a>        <span class="s2">&quot;ansible_apparmor&quot;</span>: <span class="o">{</span>
<a id="__codelineno-11-15" name="__codelineno-11-15" href="#ansible-installation-__codelineno-11-15"></a>            <span class="s2">&quot;status&quot;</span>: <span class="s2">&quot;enabled&quot;</span>
<a id="__codelineno-11-16" name="__codelineno-11-16" href="#ansible-installation-__codelineno-11-16"></a>        <span class="o">}</span>,
<a id="__codelineno-11-17" name="__codelineno-11-17" href="#ansible-installation-__codelineno-11-17"></a>        <span class="s2">&quot;ansible_architecture&quot;</span>: <span class="s2">&quot;x86_64&quot;</span>,
<a id="__codelineno-11-18" name="__codelineno-11-18" href="#ansible-installation-__codelineno-11-18"></a>        <span class="s2">&quot;ansible_bios_date&quot;</span>: <span class="s2">&quot;12/01/2006&quot;</span>,
<a id="__codelineno-11-19" name="__codelineno-11-19" href="#ansible-installation-__codelineno-11-19"></a>        <span class="s2">&quot;ansible_bios_vendor&quot;</span>: <span class="s2">&quot;innotek GmbH&quot;</span>,
<a id="__codelineno-11-20" name="__codelineno-11-20" href="#ansible-installation-__codelineno-11-20"></a>        <span class="s2">&quot;ansible_bios_version&quot;</span>: <span class="s2">&quot;VirtualBox&quot;</span>,
<a id="__codelineno-11-21" name="__codelineno-11-21" href="#ansible-installation-__codelineno-11-21"></a>        <span class="s2">&quot;ansible_board_asset_tag&quot;</span>: <span class="s2">&quot;NA&quot;</span>,
<a id="__codelineno-11-22" name="__codelineno-11-22" href="#ansible-installation-__codelineno-11-22"></a>        <span class="s2">&quot;ansible_board_name&quot;</span>: <span class="s2">&quot;VirtualBox&quot;</span>,
<a id="__codelineno-11-23" name="__codelineno-11-23" href="#ansible-installation-__codelineno-11-23"></a>        <span class="s2">&quot;ansible_board_serial&quot;</span>: <span class="s2">&quot;NA&quot;</span>,
<a id="__codelineno-11-24" name="__codelineno-11-24" href="#ansible-installation-__codelineno-11-24"></a>        <span class="s2">&quot;ansible_board_vendor&quot;</span>: <span class="s2">&quot;Oracle Corporation&quot;</span>,
<a id="__codelineno-11-25" name="__codelineno-11-25" href="#ansible-installation-__codelineno-11-25"></a>        ...
</code></pre></div>
<h3 id="ansible-installation-ansible-navigator">Ansible Navigator</h3>
<p>The <code>ansible-navigator</code> is text-based user interface (TUI) for the Red Hat Ansible Automation Platform. It is a command based tool for creating, reviewing, and troubleshooting Ansible content, including inventories, playbooks, and collections. 
The Navigator also makes use of the Execution Environments and provides an easier to use interface to interact with EEs.</p></section><section class="print-page" id="ansible-project"><h1 id="ansible-project-project">Project</h1>
<h2 id="ansible-project-version-control">Version Control</h2>
<p>Keep your playbooks and inventory file in git (or another version control system), and commit when you make changes to them. This way you have an audit trail describing when and why you changed the rules that are automating your infrastructure.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Always use version control!</p>
</div>
<h2 id="ansible-project-ansible-configuration">Ansible configuration</h2>
<p>Always use a project-specific <code>ansible.cfg</code> in the parent directory of your project. The following configuration can be used as a starting point:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-project-__codelineno-0-1"></a><span class="c1"># Define inventory, no need to provide &#39;-i&#39; anymore.</span><span class="w"></span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#ansible-project-__codelineno-0-2"></a><span class="na">inventory</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">inventory/production.ini</span><span class="w"></span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#ansible-project-__codelineno-0-3"></a>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#ansible-project-__codelineno-0-4"></a><span class="c1"># Playbook-Output in YAML instead of JSON, needs additional collection.</span><span class="w"></span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#ansible-project-__codelineno-0-5"></a><span class="na">stdout_callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">community.general.yaml</span><span class="w"></span>
</code></pre></div>
<h2 id="ansible-project-dependencies">Dependencies</h2>
<p>Your project will have certain dependencies, make sure to provide a <code>requirements.yml</code> for necessary Ansible collections and a <code>requirements.txt</code> for necessary Python packages.<br />
Consider using <a href="#ansible-installation-execution-environments"><em>Execution Environments</em></a> where all dependencies are combined in a Container Image.</p>
<h3 id="ansible-project-collections">Collections</h3>
<p>Always provide a <code>requirements.yml</code> with <strong>all</strong> collections used within your project.<br />
This makes sure that required collections can be installed, if only the <em>ansible-core</em> binary is installed.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-project-__codelineno-1-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#ansible-project-__codelineno-1-2"></a><span class="nt">collections</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#ansible-project-__codelineno-1-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">community.general</span><span class="w"></span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#ansible-project-__codelineno-1-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.posix</span><span class="w"></span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#ansible-project-__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#ansible-project-__codelineno-1-6"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cisco.ios</span><span class="w"></span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#ansible-project-__codelineno-1-7"></a><span class="w">    </span><span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;&gt;=3.1.0&#39;</span><span class="w">  </span>
</code></pre></div>
<p>Install all collections from the <em>requirements</em>-file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-project-__codelineno-2-1"></a>ansible-galaxy collection install -r requirements.yml
</code></pre></div>
<h3 id="ansible-project-python-packages">Python packages</h3>
<p>Always provide a <code>requirements.txt</code> with <strong>all</strong> Python packages need by modules used within your project.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#ansible-project-__codelineno-3-1"></a>boto
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#ansible-project-__codelineno-3-2"></a>openshift&gt;=0.6
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#ansible-project-__codelineno-3-3"></a>PyYAML&gt;=3.11
</code></pre></div>
<p>Install all dependencies from the <em>requirements</em>-file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#ansible-project-__codelineno-4-1"></a>pip3 install -r requirements.txt
</code></pre></div>
<h2 id="ansible-project-directory-structure">Directory structure</h2>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#ansible-project-__codelineno-5-1"></a>.
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#ansible-project-__codelineno-5-2"></a>├── ansible.cfg
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#ansible-project-__codelineno-5-3"></a>├── hosts
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#ansible-project-__codelineno-5-4"></a>├── k8s-install.yml
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#ansible-project-__codelineno-5-5"></a>├── README.md
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#ansible-project-__codelineno-5-6"></a>├── requirements.txt
<a id="__codelineno-5-7" name="__codelineno-5-7" href="#ansible-project-__codelineno-5-7"></a>├── requirements.yml
<a id="__codelineno-5-8" name="__codelineno-5-8" href="#ansible-project-__codelineno-5-8"></a>└── roles
<a id="__codelineno-5-9" name="__codelineno-5-9" href="#ansible-project-__codelineno-5-9"></a>    ├── k8s-bootstrap
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#ansible-project-__codelineno-5-10"></a>    │   ├── files
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#ansible-project-__codelineno-5-11"></a>    │   │   ├── daemon.json
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#ansible-project-__codelineno-5-12"></a>    │   │   └── k8s.conf
<a id="__codelineno-5-13" name="__codelineno-5-13" href="#ansible-project-__codelineno-5-13"></a>    │   ├── tasks
<a id="__codelineno-5-14" name="__codelineno-5-14" href="#ansible-project-__codelineno-5-14"></a>    │   │   ├── install-kubeadm.yml
<a id="__codelineno-5-15" name="__codelineno-5-15" href="#ansible-project-__codelineno-5-15"></a>    │   │   ├── main.yml
<a id="__codelineno-5-16" name="__codelineno-5-16" href="#ansible-project-__codelineno-5-16"></a>    │   │   └── prerequisites.yml
<a id="__codelineno-5-17" name="__codelineno-5-17" href="#ansible-project-__codelineno-5-17"></a>    │   └── templates
<a id="__codelineno-5-18" name="__codelineno-5-18" href="#ansible-project-__codelineno-5-18"></a>    │       └── kubernetes.repo.j2
<a id="__codelineno-5-19" name="__codelineno-5-19" href="#ansible-project-__codelineno-5-19"></a>    ├── k8s-control-plane
<a id="__codelineno-5-20" name="__codelineno-5-20" href="#ansible-project-__codelineno-5-20"></a>    │   ├── files
<a id="__codelineno-5-21" name="__codelineno-5-21" href="#ansible-project-__codelineno-5-21"></a>    │   │   └── kubeconfig.sh
<a id="__codelineno-5-22" name="__codelineno-5-22" href="#ansible-project-__codelineno-5-22"></a>    │   └── tasks
<a id="__codelineno-5-23" name="__codelineno-5-23" href="#ansible-project-__codelineno-5-23"></a>    │       └── main.yml
<a id="__codelineno-5-24" name="__codelineno-5-24" href="#ansible-project-__codelineno-5-24"></a>    └── k8s-worker-nodes
<a id="__codelineno-5-25" name="__codelineno-5-25" href="#ansible-project-__codelineno-5-25"></a>        └── tasks
<a id="__codelineno-5-26" name="__codelineno-5-26" href="#ansible-project-__codelineno-5-26"></a>            └── main.yml
</code></pre></div>
<h3 id="ansible-project-filenames">Filenames</h3>
<p>Folder- and file-names consisting of multiple words are separated with hyphens (e.g. <code>roles/grafana-deployment/tasks/grafana-installation.yml</code>).<br />
YAML files are saved with the extension <code>.yml</code>. </p>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="ansible-project-__tabbed_1_1" name="ansible-project-__tabbed_1" type="radio" /><input id="ansible-project-__tabbed_1_2" name="ansible-project-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="ansible-project-__tabbed_1_1">Good</label><label for="ansible-project-__tabbed_1_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#ansible-project-__codelineno-6-1"></a>.
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#ansible-project-__codelineno-6-2"></a>├── ansible.cfg
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#ansible-project-__codelineno-6-3"></a>├── hosts
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#ansible-project-__codelineno-6-4"></a>├── k8s-install.yml
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#ansible-project-__codelineno-6-5"></a>├── README.md
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#ansible-project-__codelineno-6-6"></a>├── requirements.yml
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#ansible-project-__codelineno-6-7"></a>└── roles
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#ansible-project-__codelineno-6-8"></a>    ├── k8s-bootstrap
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#ansible-project-__codelineno-6-9"></a>    │   ├── files
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#ansible-project-__codelineno-6-10"></a>    │   │   ├── daemon.json
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#ansible-project-__codelineno-6-11"></a>    │   │   └── k8s.conf
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#ansible-project-__codelineno-6-12"></a>    │   ├── tasks
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#ansible-project-__codelineno-6-13"></a>    │   │   ├── install-kubeadm.yml
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#ansible-project-__codelineno-6-14"></a>    │   │   ├── main.yml
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#ansible-project-__codelineno-6-15"></a>    │   │   └── prerequisites.yml
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#ansible-project-__codelineno-6-16"></a>    │   └── templates
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#ansible-project-__codelineno-6-17"></a>    │       └── kubernetes.repo.j2
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#ansible-project-__codelineno-6-18"></a>    ├── k8s-control-plane
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#ansible-project-__codelineno-6-19"></a>    │   ├── files
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#ansible-project-__codelineno-6-20"></a>    │   │   └── kubeconfig.sh
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#ansible-project-__codelineno-6-21"></a>    │   └── tasks
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#ansible-project-__codelineno-6-22"></a>    │       └── main.yml
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#ansible-project-__codelineno-6-23"></a>    └── k8s-worker-nodes
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#ansible-project-__codelineno-6-24"></a>        └── tasks
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#ansible-project-__codelineno-6-25"></a>            └── main.yml
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Playbook-name without hyphens and wrong file extension, role folders or task files inconsistent, with underscores and wrong extension.
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#ansible-project-__codelineno-7-1"></a>.
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#ansible-project-__codelineno-7-2"></a>├── ansible.cfg
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#ansible-project-__codelineno-7-3"></a>├── hosts
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#ansible-project-__codelineno-7-4"></a>├── k8s-install.yaml
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#ansible-project-__codelineno-7-5"></a>├── README.md
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#ansible-project-__codelineno-7-6"></a>└── roles
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#ansible-project-__codelineno-7-7"></a>    ├── k8s_bootstrap
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#ansible-project-__codelineno-7-8"></a>    │   ├── files
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#ansible-project-__codelineno-7-9"></a>    │   │   ├── daemon.json
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#ansible-project-__codelineno-7-10"></a>    │   │   └── k8s.conf
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#ansible-project-__codelineno-7-11"></a>    │   ├── tasks
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#ansible-project-__codelineno-7-12"></a>    │   │   ├── installKubeadm.yaml
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#ansible-project-__codelineno-7-13"></a>    │   │   ├── main.yml
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#ansible-project-__codelineno-7-14"></a>    │   │   └── prerequisites.yaml
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#ansible-project-__codelineno-7-15"></a>    │   └── templates
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#ansible-project-__codelineno-7-16"></a>    │       └── kubernetes.repo.j2
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#ansible-project-__codelineno-7-17"></a>    ├── k8sControlPlane
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#ansible-project-__codelineno-7-18"></a>    │   ├── files
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#ansible-project-__codelineno-7-19"></a>    │   │   └── kubeconfig.sh
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#ansible-project-__codelineno-7-20"></a>    │   └── tasks
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#ansible-project-__codelineno-7-21"></a>    │       └── main.yaml
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#ansible-project-__codelineno-7-22"></a>    └── k8s_worker-nodes
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#ansible-project-__codelineno-7-23"></a>        └── tasks
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#ansible-project-__codelineno-7-24"></a>            └── main.yaml
</code></pre></div></p>
</div>
</div>
</div>
</div>
<div class="admonition note">
<p class="admonition-title">Subject to change</p>
<p>Maybe this has to change in the future, as <em>collection roles</em> only allow <em>underscores</em> for separation.<br />
See <a href="https://docs.ansible.com/ansible/devel/dev_guide/developing_collections_structure.html#roles-directory">Ansible Docs - Roles directory</a> for more information.<br />
Also, <em>ansible-lint</em> checks role names to ensure they conform these requirements, which must be disabled otherwise.</p>
</div>
<h2 id="ansible-project-yaml-syntax">YAML Syntax</h2>
<p>Following a basic YAML coding style accross the whole team improves readability and reusability.</p>
<h3 id="ansible-project-indentation">Indentation</h3>
<p>Two spaces are used to indent everything, e.g. list items or dictionary keys.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="ansible-project-__tabbed_2_1" name="ansible-project-__tabbed_2" type="radio" /><input id="ansible-project-__tabbed_2_2" name="ansible-project-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="ansible-project-__tabbed_2_1">Good</label><label for="ansible-project-__tabbed_2_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<p>Playbook:
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#ansible-project-__codelineno-8-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Demo play</span><span class="w"></span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#ansible-project-__codelineno-8-2"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">database_servers</span><span class="w"></span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#ansible-project-__codelineno-8-3"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#ansible-project-__codelineno-8-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">common</span><span class="w"></span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#ansible-project-__codelineno-8-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span><span class="w"></span>
</code></pre></div>
Variable-file:
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#ansible-project-__codelineno-9-1"></a><span class="nt">ntp_server_list</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#ansible-project-__codelineno-9-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.de.pool.ntp.org</span><span class="w"></span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#ansible-project-__codelineno-9-3"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.de.pool.ntp.org</span><span class="w"></span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#ansible-project-__codelineno-9-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.de.pool.ntp.org</span><span class="w"></span>
<a id="__codelineno-9-5" name="__codelineno-9-5" href="#ansible-project-__codelineno-9-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.de.pool.ntp.org</span><span class="w"></span>
</code></pre></div></p>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Playbook with roles <strong>not</strong> indented by two whitespaces.
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#ansible-project-__codelineno-10-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Demo play</span><span class="w"></span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#ansible-project-__codelineno-10-2"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">database_servers</span><span class="w"></span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#ansible-project-__codelineno-10-3"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#ansible-project-__codelineno-10-4"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">common</span><span class="w"></span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#ansible-project-__codelineno-10-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span><span class="w"></span>
</code></pre></div>
List in variable-file indented with four whitespaces:
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#ansible-project-__codelineno-11-1"></a><span class="nt">ntp_server_list</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#ansible-project-__codelineno-11-2"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.de.pool.ntp.org</span><span class="w"></span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#ansible-project-__codelineno-11-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.de.pool.ntp.org</span><span class="w"></span>
<a id="__codelineno-11-4" name="__codelineno-11-4" href="#ansible-project-__codelineno-11-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.de.pool.ntp.org</span><span class="w"></span>
<a id="__codelineno-11-5" name="__codelineno-11-5" href="#ansible-project-__codelineno-11-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.de.pool.ntp.org</span><span class="w"></span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<p>The so-called YAML "one-line" syntax is not used, neither for passing parameters in tasks, nor for lists or dictionaries.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="ansible-project-__tabbed_3_1" name="ansible-project-__tabbed_3" type="radio" /><input id="ansible-project-__tabbed_3_2" name="ansible-project-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="ansible-project-__tabbed_3_1">Good</label><label for="ansible-project-__tabbed_3_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#ansible-project-__codelineno-12-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install the latest version of Apache from the testing repo</span><span class="w"></span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#ansible-project-__codelineno-12-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#ansible-project-__codelineno-12-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span><span class="w"></span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#ansible-project-__codelineno-12-4"></a><span class="w">    </span><span class="nt">enablerepo</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">testing</span><span class="w"></span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#ansible-project-__codelineno-12-5"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#ansible-project-__codelineno-13-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install a list of packages</span><span class="w"></span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#ansible-project-__codelineno-13-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#ansible-project-__codelineno-13-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#ansible-project-__codelineno-13-4"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">nginx</span><span class="w"></span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#ansible-project-__codelineno-13-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql</span><span class="w"></span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#ansible-project-__codelineno-13-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgresql-server</span><span class="w"></span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#ansible-project-__codelineno-13-7"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
</code></pre></div></p>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Task with <em>One-line</em> syntax:
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#ansible-project-__codelineno-14-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install the latest version of Apache from the testing repo</span><span class="w"></span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#ansible-project-__codelineno-14-2"></a><span class="w">  </span><span class="nt">yum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">name=httpd enablerepo=testing state=present</span><span class="w"></span>
</code></pre></div>
List in task with <em>One-line</em> syntax:
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#ansible-project-__codelineno-15-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install a list of packages</span><span class="w"></span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#ansible-project-__codelineno-15-2"></a><span class="w">  </span><span class="nt">yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#ansible-project-__codelineno-15-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&#39;nginx&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;postgresql&#39;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&#39;postgresql-server&#39;</span><span class="p p-Indicator">]</span><span class="w"></span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#ansible-project-__codelineno-15-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<h3 id="ansible-project-booleans">Booleans</h3>
<p>Use <code>true</code> and <code>false</code> for boolean values in playbooks.<br />
Do not use the Ansible-specific <code>yes</code> and <code>no</code> as boolean values in YAML as these are completely custom extensions used by Ansible and are not part of the YAML spec. Also, avoid the use of the Python-style <code>True</code> and <code>False</code> for boolean values.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="ansible-project-__tabbed_4_1" name="ansible-project-__tabbed_4" type="radio" /><input id="ansible-project-__tabbed_4_2" name="ansible-project-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="ansible-project-__tabbed_4_1">Good</label><label for="ansible-project-__tabbed_4_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#ansible-project-__codelineno-16-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Start and enable service httpd</span><span class="w"></span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#ansible-project-__codelineno-16-2"></a><span class="w">  </span><span class="nt">ansible.builtin.service</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#ansible-project-__codelineno-16-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span><span class="w"></span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#ansible-project-__codelineno-16-4"></a><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#ansible-project-__codelineno-16-5"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">started</span><span class="w"></span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#ansible-project-__codelineno-17-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Start and enable service httpd</span><span class="w"></span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#ansible-project-__codelineno-17-2"></a><span class="w">  </span><span class="nt">ansible.builtin.service</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#ansible-project-__codelineno-17-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span><span class="w"></span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#ansible-project-__codelineno-17-4"></a><span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span><span class="w"></span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#ansible-project-__codelineno-17-5"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">started</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
</div>
<p><em>YAML 1.1</em> allows all variants whereas <em>YAML 1.2</em> allows only <em>true/false</em>, you can avoid a massive migration effort for when it becomes the default.</p>
<p>Use the <code>| bool</code> filter when using bare variables (expressions consisting of just one variable reference without any operator) in <code>when</code> conditions.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="ansible-project-__tabbed_5_1" name="ansible-project-__tabbed_5" type="radio" /><input id="ansible-project-__tabbed_5_2" name="ansible-project-__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="ansible-project-__tabbed_5_1">Good</label><label for="ansible-project-__tabbed_5_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<p>Using a variable <code>upgrade_allowed</code> with the default value <code>false</code>, task is executed when overwritten with <code>true</code> value.
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#ansible-project-__codelineno-18-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upgrade all packages, excluding kernel &amp; foo related packages</span><span class="w"></span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#ansible-project-__codelineno-18-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#ansible-project-__codelineno-18-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#ansible-project-__codelineno-18-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span><span class="w"></span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#ansible-project-__codelineno-18-5"></a><span class="w">    </span><span class="nt">exclude</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kernel*,foo*</span><span class="w"></span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#ansible-project-__codelineno-18-6"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">upgrade_allowed | bool</span><span class="w"></span>
</code></pre></div></p>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#ansible-project-__codelineno-19-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Upgrade all packages, excluding kernel &amp; foo related packages</span><span class="w"></span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#ansible-project-__codelineno-19-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#ansible-project-__codelineno-19-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;*&quot;</span><span class="w"></span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#ansible-project-__codelineno-19-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">latest</span><span class="w"></span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#ansible-project-__codelineno-19-5"></a><span class="w">    </span><span class="nt">exclude</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kernel*,foo*</span><span class="w"></span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#ansible-project-__codelineno-19-6"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">upgrade_allowed</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
</div>
<h3 id="ansible-project-quoting">Quoting</h3>
<p>Do not use quotes unless you have to, especially for short module-keyword-like strings like <em>present</em>, <em>absent</em>, etc.<br />
When using quotes, use the same <em>type</em> of quotes throughout your playbooks. Always use <strong>double quotes</strong> (<code>"</code>), whenever possible.</p>
<h2 id="ansible-project-comments">Comments</h2>
<p>Use loads of comments!<br />
Well, the <em>name</em> parameter should desribe your task in detail, but if your task uses multiple filters or regexes, comments should be used for further explanation.<br />
Commented code is generally to be avoided. Playbooks or task files are not committed, if they contain commented out code.  </p>
<div class="admonition bad-practice">
<p class="admonition-title">Bad</p>
<p>Why is the second task commented? Is it not necessary anymore? Does it not work as expected? 
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#ansible-project-__codelineno-20-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Change port to {{ grafana_port }}</span><span class="w"></span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#ansible-project-__codelineno-20-2"></a><span class="w">  </span><span class="nt">community.general.ini_file</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#ansible-project-__codelineno-20-3"></a><span class="w">    </span><span class="nt">path</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/grafana/grafana.ini</span><span class="w"></span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#ansible-project-__codelineno-20-4"></a><span class="w">    </span><span class="nt">section</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">server</span><span class="w"></span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#ansible-project-__codelineno-20-5"></a><span class="w">    </span><span class="nt">option</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">http_port</span><span class="w"></span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#ansible-project-__codelineno-20-6"></a><span class="w">    </span><span class="nt">value</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">grafana_port</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#ansible-project-__codelineno-20-7"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#ansible-project-__codelineno-20-8"></a><span class="w">  </span><span class="nt">notify</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">restart grafana</span><span class="w"></span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#ansible-project-__codelineno-20-9"></a>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#ansible-project-__codelineno-20-10"></a><span class="c1"># - name: Change theme to {{ grafana_theme }}</span><span class="w"></span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#ansible-project-__codelineno-20-11"></a><span class="c1">#   ansible.builtin.lineinfile:</span><span class="w"></span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#ansible-project-__codelineno-20-12"></a><span class="c1">#     path: /etc/grafana/grafana.ini</span><span class="w"></span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#ansible-project-__codelineno-20-13"></a><span class="c1">#     regexp: &#39;.*default_theme =&#39;</span><span class="w"></span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#ansible-project-__codelineno-20-14"></a><span class="c1">#     line: &quot;default_theme = {{ grafana_theme }}&quot;</span><span class="w"></span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#ansible-project-__codelineno-20-15"></a><span class="c1">#   become: yes</span><span class="w"></span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#ansible-project-__codelineno-20-16"></a><span class="c1">#   notify: restart grafana</span><span class="w"></span>
</code></pre></div></p>
<div class="admonition good-practice">
<p class="admonition-title">Comment commented tasks</p>
<p>If you really have to comment the whole task, add a description why, when and by whom it was commented.</p>
</div>
</div></section><section class="print-page" id="ansible-inventory"><h1 id="ansible-inventory-inventory">Inventory</h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Work in Progress</strong> - More description necessary.</p>
</div>
<h2 id="ansible-inventory-multiple-inventory-files">Multiple inventory files</h2>
<h2 id="ansible-inventory-inventory_1">Inventory</h2>
<p>Es werden unterschiedliche Inventories verwendet, alle Inventory-Dateien werden im Ordner <strong><em>inventory</em></strong> hinterlegt.<br />
Gruppen im Inventory werden in der folgenden Reihenfolge definiert:</p>
<ol>
<li>Parent</li>
<li>Children</li>
<li>Parent-Variablen</li>
<li>Child-Variablen</li>
</ol></section><section class="print-page" id="ansible-variables"><h1 id="ansible-variables-variables">Variables</h1>
<h2 id="ansible-variables-where-to-put-variables">Where to put variables</h2>
<p>I always store all my variables at the following <strong>three</strong> locations:</p>
<ul>
<li><em>group_vars</em> folder</li>
<li><em>host_vars</em> folder</li>
<li><em>defaults</em> folder in roles</li>
</ul>
<p>The <em>defaults</em>-folder contains only default values for all variables used by the role.</p>
<h2 id="ansible-variables-naming-variables">Naming Variables</h2>
<p>The variable name should be self-explanatory (<em>as brief as possible, as detailed as necessary</em>), use multiple words and don't shorten things.</p>
<ul>
<li>Multiple words are separated with underscores (<code>_</code>)</li>
<li><em>List</em>-Variables are suffixed with <code>_list</code></li>
<li><em>Dictionary</em>-Variables are suffixed with <code>_dict</code></li>
<li><em>Boolean</em> values are provided with lowercase <code>true</code> or <code>false</code></li>
</ul>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="ansible-variables-__tabbed_1_1" name="ansible-variables-__tabbed_1" type="radio" /><input id="ansible-variables-__tabbed_1_2" name="ansible-variables-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="ansible-variables-__tabbed_1_1">Good</label><label for="ansible-variables-__tabbed_1_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-variables-__codelineno-0-1"></a><span class="nt">download_directory</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/.local/bin</span><span class="w"></span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#ansible-variables-__codelineno-0-2"></a><span class="nt">create_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#ansible-variables-__codelineno-0-3"></a><span class="nt">needs_agent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-variables-__codelineno-1-1"></a><span class="nt">dir</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">~/.local/bin</span><span class="w"></span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#ansible-variables-__codelineno-1-2"></a><span class="nt">create_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">yes</span><span class="w"></span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#ansible-variables-__codelineno-1-3"></a><span class="nt">needsAgent</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">no</span><span class="w"></span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#ansible-variables-__codelineno-1-4"></a><span class="nt">knows_oop</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
</div>
<h2 id="ansible-variables-referencing-variables">Referencing variables</h2>
<p>After a variable is defined, use <em>Jinja2</em> syntax to reference it. Jinja2 variables use <em>double curly braces</em> (<code>{{</code> and <code>}}</code>).<br />
Use spaces after and before the double curly braces and the variable name.<br />
When referencing <em>list</em> or <em>dictionary</em> variables, try to use the <em>bracket notation</em> instead of the <em>dot notation</em>.
Bracket notation always works and you can use variables inside the brackets. Dot notation can cause problems because some keys collide with attributes and methods of python dictionaries. </p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="ansible-variables-__tabbed_2_1" name="ansible-variables-__tabbed_2" type="radio" /><input id="ansible-variables-__tabbed_2_2" name="ansible-variables-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="ansible-variables-__tabbed_2_1">Good</label><label for="ansible-variables-__tabbed_2_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<p>Simple variable reference:
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-variables-__codelineno-2-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy configuration file</span><span class="w"></span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#ansible-variables-__codelineno-2-2"></a><span class="w">  </span><span class="nt">ansible.builtin.template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#ansible-variables-__codelineno-2-3"></a><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo.cfg.j2</span><span class="w"></span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#ansible-variables-__codelineno-2-4"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">remote_install_path</span><span class="nv"> </span><span class="s">}}/foo.cfg&quot;</span><span class="w"></span>
</code></pre></div>
Bracket-notation and using variable (<em>interface_name</em>) inside:
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#ansible-variables-__codelineno-3-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Output IPv4 address of {{ interface_name }} interface</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#ansible-variables-__codelineno-3-2"></a><span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#ansible-variables-__codelineno-3-3"></a><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">ansible_facts[interface_name][&#39;ipv4&#39;][&#39;address&#39;]</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
</code></pre></div></p>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Not using whitespaces around variable name.
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#ansible-variables-__codelineno-4-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deploy configuration file</span><span class="w"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#ansible-variables-__codelineno-4-2"></a><span class="w">  </span><span class="nt">ansible.builtin.template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#ansible-variables-__codelineno-4-3"></a><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">foo.cfg.j2</span><span class="w"></span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#ansible-variables-__codelineno-4-4"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{remote_install_path}}/foo.cfg&quot;</span><span class="w"></span>
</code></pre></div>
Not using whitespaces and using dot-notation.
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#ansible-variables-__codelineno-5-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Output IPv4 address of eth0 interface</span><span class="w"></span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#ansible-variables-__codelineno-5-2"></a><span class="w">  </span><span class="nt">ansible.builtin.debug</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#ansible-variables-__codelineno-5-3"></a><span class="w">    </span><span class="nt">msg</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{ansible_facts.eth0.ipv4.address}}&quot;</span><span class="w"></span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<h2 id="ansible-variables-encrypted-variables">Encrypted variables</h2>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>All variables with sensitive content should be <em>vault</em>-encrypted.  </p>
</div>
<p>Although encrypting just the value of a single variable is possible (with <code>ansible-vault encrypt_string</code>), you should avoid this. Store all sensitive variables in a single file and encrypt the whole file.<br />
For example, to store sensitive variables in <code>group_vars</code>, create the subdirectory for the group and within create two files named <code>vars.yml</code> and <code>vault.yml</code>.<br />
Inside of the <code>vars.yml</code> file, define all of the variables needed, including any sensitive ones. Next, copy all of the sensitive variables over to the <code>vault.yml</code> file and prefix these variables with <code>vault_</code>. Adjust the variables in the <em>vars</em> file to point to the matching <em>vault_</em> variables using Jinja2 syntax, and ensure that the vault file is vault encrypted.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="ansible-variables-__tabbed_3_1" name="ansible-variables-__tabbed_3" type="radio" /><input id="ansible-variables-__tabbed_3_2" name="ansible-variables-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="ansible-variables-__tabbed_3_1">Good</label><label for="ansible-variables-__tabbed_3_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#ansible-variables-__codelineno-6-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#ansible-variables-__codelineno-6-2"></a><span class="c1"># file: group_vars/database_servers/vars.yml</span><span class="w"></span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#ansible-variables-__codelineno-6-3"></a><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vault_username</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#ansible-variables-__codelineno-6-4"></a><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">vault_password</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#ansible-variables-__codelineno-7-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#ansible-variables-__codelineno-7-2"></a><span class="c1"># file: group_vars/database_servers/vault.yml</span><span class="w"></span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#ansible-variables-__codelineno-7-3"></a><span class="c1"># NOTE: THIS FILE MUST ALWAYS BE VAULT-ENCRYPTED</span><span class="w"></span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#ansible-variables-__codelineno-7-4"></a><span class="nt">vault_username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span><span class="w"></span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#ansible-variables-__codelineno-7-5"></a><span class="nt">vault_password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ex4mple</span><span class="w"></span>
</code></pre></div></p>
<details class="info">
<summary>I can still read the credentials...?</summary>
<p>Obviously, you wouldn't be able to read the content of the file <code>group_vars/database_servers/vault.yml</code>, as the file would be encrypted.<br />
<strong>This only demonstrates how the variables are referencing each other.</strong><br />
The encrypted <code>vault.yml</code> file looks something like this:
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#ansible-variables-__codelineno-8-1"></a><span class="l l-Scalar l-Scalar-Plain">$ANSIBLE_VAULT;1.1;AES256</span><span class="w"></span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#ansible-variables-__codelineno-8-2"></a><span class="l l-Scalar l-Scalar-Plain">30653164396132376333316665656131666165613863343330616666376264353830323234623631</span><span class="w"></span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#ansible-variables-__codelineno-8-3"></a><span class="l l-Scalar l-Scalar-Plain">6361303062336532303665643765336464656164363662370a663834313837303437323332336631</span><span class="w"></span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#ansible-variables-__codelineno-8-4"></a><span class="l l-Scalar l-Scalar-Plain">65656335643031393065333366366639653330353634303664653135653230656461666266356530</span><span class="w"></span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#ansible-variables-__codelineno-8-5"></a><span class="l l-Scalar l-Scalar-Plain">3935346533343834650a323934346666383032636562613966633136663631636435333834393261</span><span class="w"></span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#ansible-variables-__codelineno-8-6"></a><span class="l l-Scalar l-Scalar-Plain">36363833373439333735653262306331333062383630623432633134386138656636343137333439</span><span class="w"></span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#ansible-variables-__codelineno-8-7"></a><span class="l l-Scalar l-Scalar-Plain">61633965323066633433373137383330366466366332626334633234376231393330363335353436</span><span class="w"></span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#ansible-variables-__codelineno-8-8"></a><span class="l l-Scalar l-Scalar-Plain">62383866616232323132376366326161386561666238623731323835633237373036636561666165</span><span class="w"></span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#ansible-variables-__codelineno-8-9"></a><span class="l l-Scalar l-Scalar-Plain">36363838313737656232376365346136633934373861326130636531616438643036656137373762</span><span class="w"></span>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#ansible-variables-__codelineno-8-10"></a><span class="l l-Scalar l-Scalar-Plain">39616234353135613063393536306536303065653231306166306432623232356465613063336439</span><span class="w"></span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#ansible-variables-__codelineno-8-11"></a><span class="l l-Scalar l-Scalar-Plain">34636232346334386464313935356537323832666436393336366536626463326631653137313639</span><span class="w"></span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#ansible-variables-__codelineno-8-12"></a><span class="l l-Scalar l-Scalar-Plain">36353532623161653266666436646135396632656133623762643131323439613534643430636333</span><span class="w"></span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#ansible-variables-__codelineno-8-13"></a><span class="l l-Scalar l-Scalar-Plain">31386635613238613233</span><span class="w"></span>
</code></pre></div></p>
</details>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#ansible-variables-__codelineno-9-1"></a><span class="c1"># file: group_vars/database_servers.yml</span><span class="w"></span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#ansible-variables-__codelineno-9-2"></a><span class="nt">username</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admin</span><span class="w"></span>
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#ansible-variables-__codelineno-9-3"></a><span class="nt">password</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ex4mple</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
</div>
<p>Defining variables this way makes sure that you can still find them with <em>grep</em>.</p>
<p>Encrypting files can be done with this command:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#ansible-variables-__codelineno-10-1"></a>ansible-vault encrypt group_vars/database_servers/vault.yml
</code></pre></div>
<p>Once a variable file is encrypted, it should <strong>not</strong> be decrypted again (because it may get commited unencrypted). View or edit the file like this:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#ansible-variables-__codelineno-11-1"></a>ansible-vault view group_vars/database_servers/vault.yml
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#ansible-variables-__codelineno-12-1"></a>ansible-vault edit group_vars/database_servers/vault.yml
</code></pre></div></p></section><section class="print-page" id="ansible-playbook"><h1 id="ansible-playbook-playbooks">Playbooks</h1>
<p><em>Playbooks</em> are first thing you think of when using Ansible. This section describes some good practices.  </p>
<h2 id="ansible-playbook-directory-structure">Directory structure</h2>
<p>The <em>main</em> playbook should have a recognizable name, e.g. referencing the projects name or scope.
If you have multiple playbooks, create a new folder <code>playbooks</code> and store all playbooks there, except the <em>main</em> playbook (here called <code>site.yml</code>).</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-playbook-__codelineno-0-1"></a>.
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#ansible-playbook-__codelineno-0-2"></a>├── ansible.cfg
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#ansible-playbook-__codelineno-0-3"></a>├── site.yml
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#ansible-playbook-__codelineno-0-4"></a>└── playbooks
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#ansible-playbook-__codelineno-0-5"></a>    ├── database.yml
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#ansible-playbook-__codelineno-0-6"></a>    ├── loadbalancer.yml
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#ansible-playbook-__codelineno-0-7"></a>    └── webserver.yml
</code></pre></div>
<p>The <code>site.yml</code> file contains references to the other playbooks:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-playbook-__codelineno-1-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#ansible-playbook-__codelineno-1-2"></a><span class="c1"># Main playbook including all other playbooks</span><span class="w"></span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#ansible-playbook-__codelineno-1-3"></a>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#ansible-playbook-__codelineno-1-4"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">import_playbook</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">playbooks/database.yml</span><span class="w"></span>
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#ansible-playbook-__codelineno-1-5"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">import_playbook</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">playbooks/webserver.yml</span><span class="w"></span>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#ansible-playbook-__codelineno-1-6"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">import_playbook</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">playbooks/loadbalancer.yml</span><span class="w"></span>
</code></pre></div>
<p>The <em>lower-level</em> playbooks contains actual <a href="#ansible-playbook-plays"><em>plays</em></a>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-playbook-__codelineno-2-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#ansible-playbook-__codelineno-2-2"></a><span class="c1"># playbooks/database</span><span class="w"></span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#ansible-playbook-__codelineno-2-3"></a>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#ansible-playbook-__codelineno-2-4"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install and configure PostgreSQL database</span><span class="w"></span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#ansible-playbook-__codelineno-2-5"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres_servers</span><span class="w"></span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#ansible-playbook-__codelineno-2-6"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#ansible-playbook-__codelineno-2-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">postgres</span><span class="w"></span>
</code></pre></div>
<p>To be able to run the overall playbook, as well as the imported playbooks, add this parameter to your <code>ansible.cfg</code>, otherwise roles are not found:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#ansible-playbook-__codelineno-3-1"></a><span class="k">[defaults]</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#ansible-playbook-__codelineno-3-2"></a><span class="na">roles_path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">.roles</span><span class="w"></span>
</code></pre></div>
<h2 id="ansible-playbook-playbook-definition">Playbook definition</h2>
<p>Don't put too much logic in your playbook, put it in your roles (or even in custom modules).<br />
A playbook <strong>could</strong> contain <code>pre_tasks</code>, <code>roles</code>, <code>tasks</code> and <code>post_tasks</code> sections, try to limit your playbooks to a <strong>list of a roles</strong>. </p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Avoid using both <em>roles</em> and <em>tasks </em>sections, the latter possibly containing <code>import_role</code> or <code>include_role</code> tasks. The order of execution between <em>roles</em> and <em>tasks</em> isn’t obvious, and hence mixing them should be avoided.  </p>
</div>
<p>Either you need only static importing of roles and you can use the roles section, or you need dynamic inclusion and you should use only the tasks section. Of course, for very simple cases, you can just use tasks without roles (but playbooks/projects grow quickly, refactor to roles early).</p>
<h3 id="ansible-playbook-plays">Plays</h3>
<p>Avoid putting multiple plays in a playbook, if not really necessary. As every play most likely targets a different host group, create a separate playbook file for it. This way you achieve to most flexibility.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#ansible-playbook-__codelineno-4-1"></a><span class="c1"># file k8s-installation.yml</span><span class="w"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#ansible-playbook-__codelineno-4-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Initialize Control-Plane Nodes</span><span class="w"></span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#ansible-playbook-__codelineno-4-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubemaster</span><span class="w"></span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#ansible-playbook-__codelineno-4-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#ansible-playbook-__codelineno-4-5"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#ansible-playbook-__codelineno-4-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-control-plane</span><span class="w"></span>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#ansible-playbook-__codelineno-4-7"></a>
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#ansible-playbook-__codelineno-4-8"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install and configure Worker Nodes</span><span class="w"></span>
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#ansible-playbook-__codelineno-4-9"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeworker</span><span class="w"></span>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#ansible-playbook-__codelineno-4-10"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#ansible-playbook-__codelineno-4-11"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#ansible-playbook-__codelineno-4-12"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-worker-nodes</span><span class="w"></span>
</code></pre></div>
<p>Separate the two plays into their respective playbooks files and reference them in an overall playbook file:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#ansible-playbook-__codelineno-5-1"></a><span class="c1"># file k8s-control-plane-playbook.yml</span><span class="w"></span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#ansible-playbook-__codelineno-5-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Initialize Control-Plane Nodes</span><span class="w"></span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#ansible-playbook-__codelineno-5-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubemaster</span><span class="w"></span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#ansible-playbook-__codelineno-5-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#ansible-playbook-__codelineno-5-5"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-5-6" name="__codelineno-5-6" href="#ansible-playbook-__codelineno-5-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-control-plane</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#ansible-playbook-__codelineno-6-1"></a><span class="c1"># file k8s-worker-node-playbook.yml</span><span class="w"></span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#ansible-playbook-__codelineno-6-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install and configure Worker Nodes</span><span class="w"></span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#ansible-playbook-__codelineno-6-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeworker</span><span class="w"></span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#ansible-playbook-__codelineno-6-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#ansible-playbook-__codelineno-6-5"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#ansible-playbook-__codelineno-6-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-worker-nodes</span><span class="w"></span>
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#ansible-playbook-__codelineno-7-1"></a><span class="c1"># file k8s-installation.yml</span><span class="w"></span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#ansible-playbook-__codelineno-7-2"></a>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#ansible-playbook-__codelineno-7-3"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">import_playbooks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-control-plane-playbook.yml</span><span class="w"></span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#ansible-playbook-__codelineno-7-4"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">import_playbooks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">k8s-worker-node-playbook.yml</span><span class="w"></span>
</code></pre></div></section><section class="print-page" id="ansible-roles"><h1 id="ansible-roles-roles">Roles</h1>
<p>New playbook functionality is always added in a role. Roles should only serve a defined purpose that is unambiguous by the role name.
The role name should be short and unique. It is separated with hyphens, if it consists of several words.</p>
<h2 id="ansible-roles-readme">Readme</h2>
<p>Every role must have a role-specific <code>README.md</code> describing scope and focus of the role. Use the following example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-roles-__codelineno-0-1"></a><span class="gh"># Role name/title</span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#ansible-roles-__codelineno-0-2"></a>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#ansible-roles-__codelineno-0-3"></a>Brief description of the role, what it does and what not.
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#ansible-roles-__codelineno-0-4"></a>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#ansible-roles-__codelineno-0-5"></a><span class="gu">## Requirements</span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#ansible-roles-__codelineno-0-6"></a>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#ansible-roles-__codelineno-0-7"></a>Technical requirements, e.g. necessary packages/rpms, own modules or plugins.
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#ansible-roles-__codelineno-0-8"></a>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#ansible-roles-__codelineno-0-9"></a><span class="gu">## Role Variables</span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#ansible-roles-__codelineno-0-10"></a>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#ansible-roles-__codelineno-0-11"></a>The role uses the following variables:
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#ansible-roles-__codelineno-0-12"></a>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#ansible-roles-__codelineno-0-13"></a>| Variable Name | Type    | Default Value | Description            |
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#ansible-roles-__codelineno-0-14"></a>| ------------- | ------- | ------------- | ---------------------- |
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#ansible-roles-__codelineno-0-15"></a>| example       | Boolean | false         | Brief description      |
<a id="__codelineno-0-16" name="__codelineno-0-16" href="#ansible-roles-__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17" href="#ansible-roles-__codelineno-0-17"></a><span class="gu">## Dependencies</span>
<a id="__codelineno-0-18" name="__codelineno-0-18" href="#ansible-roles-__codelineno-0-18"></a>
<a id="__codelineno-0-19" name="__codelineno-0-19" href="#ansible-roles-__codelineno-0-19"></a>This role expects to run <span class="gs">**after**</span> the following roles:
<a id="__codelineno-0-20" name="__codelineno-0-20" href="#ansible-roles-__codelineno-0-20"></a><span class="k">*</span> repository
<a id="__codelineno-0-21" name="__codelineno-0-21" href="#ansible-roles-__codelineno-0-21"></a><span class="k">*</span> networking
<a id="__codelineno-0-22" name="__codelineno-0-22" href="#ansible-roles-__codelineno-0-22"></a><span class="k">*</span> common
<a id="__codelineno-0-23" name="__codelineno-0-23" href="#ansible-roles-__codelineno-0-23"></a><span class="k">*</span> software
<a id="__codelineno-0-24" name="__codelineno-0-24" href="#ansible-roles-__codelineno-0-24"></a>
<a id="__codelineno-0-25" name="__codelineno-0-25" href="#ansible-roles-__codelineno-0-25"></a><span class="gu">## Tags</span>
<a id="__codelineno-0-26" name="__codelineno-0-26" href="#ansible-roles-__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27" href="#ansible-roles-__codelineno-0-27"></a>The role can be executed with the following tags:
<a id="__codelineno-0-28" name="__codelineno-0-28" href="#ansible-roles-__codelineno-0-28"></a><span class="k">*</span> install
<a id="__codelineno-0-29" name="__codelineno-0-29" href="#ansible-roles-__codelineno-0-29"></a><span class="k">*</span> configure
<a id="__codelineno-0-30" name="__codelineno-0-30" href="#ansible-roles-__codelineno-0-30"></a><span class="k">*</span> service
<a id="__codelineno-0-31" name="__codelineno-0-31" href="#ansible-roles-__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32" href="#ansible-roles-__codelineno-0-32"></a><span class="gu">## Example Playbook</span>
<a id="__codelineno-0-33" name="__codelineno-0-33" href="#ansible-roles-__codelineno-0-33"></a>
<a id="__codelineno-0-34" name="__codelineno-0-34" href="#ansible-roles-__codelineno-0-34"></a>Use the role in a playbook like this (after running plays/roles from dependencies section):
<a id="__codelineno-0-35" name="__codelineno-0-35" href="#ansible-roles-__codelineno-0-35"></a><span class="sb">```yaml</span>
<a id="__codelineno-0-36" name="__codelineno-0-36" href="#ansible-roles-__codelineno-0-36"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Execute role</span><span class="w"></span>
<a id="__codelineno-0-37" name="__codelineno-0-37" href="#ansible-roles-__codelineno-0-37"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example_servers</span><span class="w"></span>
<a id="__codelineno-0-38" name="__codelineno-0-38" href="#ansible-roles-__codelineno-0-38"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-0-39" name="__codelineno-0-39" href="#ansible-roles-__codelineno-0-39"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-0-40" name="__codelineno-0-40" href="#ansible-roles-__codelineno-0-40"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">example-role</span><span class="w"></span>
<a id="__codelineno-0-41" name="__codelineno-0-41" href="#ansible-roles-__codelineno-0-41"></a><span class="sb">```</span>
<a id="__codelineno-0-42" name="__codelineno-0-42" href="#ansible-roles-__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43" href="#ansible-roles-__codelineno-0-43"></a><span class="gu">## Authors</span>
<a id="__codelineno-0-44" name="__codelineno-0-44" href="#ansible-roles-__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45" href="#ansible-roles-__codelineno-0-45"></a>Tim Grützmacher - &lt;tim.gruetzmacher@computacenter.com&gt;
</code></pre></div>
<h2 id="ansible-roles-role-structure">Role structure</h2>
<h3 id="ansible-roles-role-skeleton">Role skeleton</h3>
<p>The <code>ansible-galaxy</code> utility can be used to create the role <em>skeleton</em> with the following command:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-roles-__codelineno-1-1"></a>ansible-galaxy role init roles/demo
</code></pre></div>
<p>This would create the following directory:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-roles-__codelineno-2-1"></a>roles/demo/
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#ansible-roles-__codelineno-2-2"></a>├── defaults
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#ansible-roles-__codelineno-2-3"></a>│   └── main.yml
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#ansible-roles-__codelineno-2-4"></a>├── files
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#ansible-roles-__codelineno-2-5"></a>├── handlers
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#ansible-roles-__codelineno-2-6"></a>│   └── main.yml
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#ansible-roles-__codelineno-2-7"></a>├── meta
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#ansible-roles-__codelineno-2-8"></a>│   └── main.yml
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#ansible-roles-__codelineno-2-9"></a>├── README.md
<a id="__codelineno-2-10" name="__codelineno-2-10" href="#ansible-roles-__codelineno-2-10"></a>├── tasks
<a id="__codelineno-2-11" name="__codelineno-2-11" href="#ansible-roles-__codelineno-2-11"></a>│   └── main.yml
<a id="__codelineno-2-12" name="__codelineno-2-12" href="#ansible-roles-__codelineno-2-12"></a>├── templates
<a id="__codelineno-2-13" name="__codelineno-2-13" href="#ansible-roles-__codelineno-2-13"></a>├── tests
<a id="__codelineno-2-14" name="__codelineno-2-14" href="#ansible-roles-__codelineno-2-14"></a>│   ├── inventory
<a id="__codelineno-2-15" name="__codelineno-2-15" href="#ansible-roles-__codelineno-2-15"></a>│   └── test.yml
<a id="__codelineno-2-16" name="__codelineno-2-16" href="#ansible-roles-__codelineno-2-16"></a>├── .travis.yml
<a id="__codelineno-2-17" name="__codelineno-2-17" href="#ansible-roles-__codelineno-2-17"></a>└── vars
<a id="__codelineno-2-18" name="__codelineno-2-18" href="#ansible-roles-__codelineno-2-18"></a>    └── main.yml
</code></pre></div>
<p>At least the folders (and content) <code>tests</code> (a sample inventory and playbook for testing, we will use a different testing method) and <code>vars</code> (variable definitions, not used according to this Best Practice Guide, because we use only <em>group_vars</em>, <em>host_vars</em> and <em>defaults</em>) are not necessary. Also the <code>.travis.yml</code> (a CI/CD solution) definition is not useful.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Use a custom role skeleton which is used by <code>ansible-galaxy</code>!</p>
</div>
<p>Consider the following role skeleton, note the missing <em>vars</em> and <em>test</em> folder and the newly added <a href="#development-testing-molecule">Molecule folder</a>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#ansible-roles-__codelineno-3-1"></a>roles/role-skeleton/
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#ansible-roles-__codelineno-3-2"></a>├── defaults
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#ansible-roles-__codelineno-3-3"></a>│   └── main.yml
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#ansible-roles-__codelineno-3-4"></a>├── files
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#ansible-roles-__codelineno-3-5"></a>├── handlers
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#ansible-roles-__codelineno-3-6"></a>│   └── main.yml
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#ansible-roles-__codelineno-3-7"></a>├── meta
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#ansible-roles-__codelineno-3-8"></a>│   └── main.yml
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#ansible-roles-__codelineno-3-9"></a>├── molecule
<a id="__codelineno-3-10" name="__codelineno-3-10" href="#ansible-roles-__codelineno-3-10"></a>│   └── default
<a id="__codelineno-3-11" name="__codelineno-3-11" href="#ansible-roles-__codelineno-3-11"></a>│       ├── converge.yml
<a id="__codelineno-3-12" name="__codelineno-3-12" href="#ansible-roles-__codelineno-3-12"></a>│       └── molecule.yml
<a id="__codelineno-3-13" name="__codelineno-3-13" href="#ansible-roles-__codelineno-3-13"></a>├── README.md
<a id="__codelineno-3-14" name="__codelineno-3-14" href="#ansible-roles-__codelineno-3-14"></a>├── tasks
<a id="__codelineno-3-15" name="__codelineno-3-15" href="#ansible-roles-__codelineno-3-15"></a>│   └── main.yml
<a id="__codelineno-3-16" name="__codelineno-3-16" href="#ansible-roles-__codelineno-3-16"></a>└── templates
</code></pre></div>
<p>You need to define the following parameter in your custom <code>ansible.cfg</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#ansible-roles-__codelineno-4-1"></a><span class="k">[galaxy]</span><span class="w"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#ansible-roles-__codelineno-4-2"></a><span class="na">role_skeleton</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">roles/role-skeleton</span><span class="w"></span>
</code></pre></div>
<div class="admonition success">
<p class="admonition-title">Success</p>
<p>Afterwards, initializing a new role with <code>ansible-galaxy role init</code> creates a role structure with exactly the content you need!</p>
</div></section><section class="print-page" id="ansible-tasks"><h1 id="ansible-tasks-tasks">Tasks</h1>
<p>Tasks should always be inside of a role. Do not use tasks in a play directly.<br />
Logically related tasks are to be separated into individual files, the <code>main.yml</code> of a role only imports other task files.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#ansible-tasks-__codelineno-0-1"></a>.
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#ansible-tasks-__codelineno-0-2"></a>└── roles
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#ansible-tasks-__codelineno-0-3"></a>    └── k8s-bootstrap
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#ansible-tasks-__codelineno-0-4"></a>        └── tasks
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#ansible-tasks-__codelineno-0-5"></a>            ├── install-kubeadm.yml
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#ansible-tasks-__codelineno-0-6"></a>            ├── main.yml
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#ansible-tasks-__codelineno-0-7"></a>            └── prerequisites.yml
</code></pre></div>
<p>The file name of a task file should describe the content.
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#ansible-tasks-__codelineno-1-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#ansible-tasks-__codelineno-1-2"></a><span class="c1"># tasks/main.yml</span><span class="w"></span>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#ansible-tasks-__codelineno-1-3"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prerequisites.yml</span><span class="w"></span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#ansible-tasks-__codelineno-1-4"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install-kubeadm.yml</span><span class="w"></span>
</code></pre></div></p>
<h2 id="ansible-tasks-tags">Tags</h2>
<p>Don't use too many tags, it gets confusing very quickly.<br />
Tags should only be allowed for imported task files within the <code>main.yml</code> of a role. Tags at the task level in sub-task files should be avoided.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#ansible-tasks-__codelineno-2-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#ansible-tasks-__codelineno-2-2"></a><span class="c1"># tasks/main.yml</span><span class="w"></span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#ansible-tasks-__codelineno-2-3"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">installation.yml</span><span class="w"></span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#ansible-tasks-__codelineno-2-4"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-2-5" name="__codelineno-2-5" href="#ansible-tasks-__codelineno-2-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install</span><span class="w"></span>
<a id="__codelineno-2-6" name="__codelineno-2-6" href="#ansible-tasks-__codelineno-2-6"></a>
<a id="__codelineno-2-7" name="__codelineno-2-7" href="#ansible-tasks-__codelineno-2-7"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">import_tasks</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configuration.yml</span><span class="w"></span>
<a id="__codelineno-2-8" name="__codelineno-2-8" href="#ansible-tasks-__codelineno-2-8"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-2-9" name="__codelineno-2-9" href="#ansible-tasks-__codelineno-2-9"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">configure</span><span class="w"></span>
</code></pre></div>
<p>Try to use the same tags across your roles, this way you would be able to run only e.g. <em>installation</em> tasks from multiple roles.</p>
<h2 id="ansible-tasks-idempotence">Idempotence</h2>
<p>Each task must be idempotent, if non-idempotent modules are used (<em>command</em>, <em>shell</em>, <em>raw</em>) these tasks must be developed via appropriate parameters or conditions to an idempotent mode of operation.  </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In general, the use of non-idempotent modules should be reduced to a necessary minimum. </p>
</div>
<h3 id="ansible-tasks-command-vs-shell-module"><em>command</em> vs. <em>shell</em> module</h3>
<p>In most of the use cases, both shell and command modules perform the same job. However, there are few main differences between these two modules. The <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/command_module.html" target="_blank"><em>command</em></a> module uses the Python interpreter on the target node (as all other modules), the <a href="https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html" target="_blank"><em>shell</em></a> module runs a real shell on the target (pipeing and redirections are available, as well as access to environment variables).</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Always try to use the <code>command</code> module over the <code>shell</code> module, if you do not explicitly need shell functionality.</p>
</div>
<p>Parsing shell metacharacters can lead to unexpected commands being executed if quoting is not done correctly so it is more secure to use the command module when possible. To sanitize any variables passed to the shell module, you should use <code>{{ var | quote }}</code> instead of<br />
just <code>{{ var }}</code> to make sure they do not include evil things like semicolons.</p>
<h3 id="ansible-tasks-creates-and-removes"><em>creates</em> and <em>removes</em></h3>
<p>Check mode is supported for non-idempotent modules when passing <code>creates</code> or <code>removes</code>. If running in check mode and either of these are specified, the module will check for the existence of the file and report the correct changed status. If these are not supplied, the task will be skipped.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Work in Progress</strong> - More description necessary.</p>
</div>
<h3 id="ansible-tasks-failed_when-and-changed_when"><em>failed_when</em> and <em>changed_when</em></h3>
<div class="tabbed-set tabbed-alternate" data-tabs="1:2"><input checked="checked" id="ansible-tasks-__tabbed_1_1" name="ansible-tasks-__tabbed_1" type="radio" /><input id="ansible-tasks-__tabbed_1_2" name="ansible-tasks-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_1_1">Good</label><label for="ansible-tasks-__tabbed_1_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#ansible-tasks-__codelineno-3-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install webserver package</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#ansible-tasks-__codelineno-3-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#ansible-tasks-__codelineno-3-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span><span class="w"></span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#ansible-tasks-__codelineno-3-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>This task never reports a changed state or fails when an error occurs.
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#ansible-tasks-__codelineno-4-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install webserver package</span><span class="w"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#ansible-tasks-__codelineno-4-2"></a><span class="w">  </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sudo yum install http</span><span class="w"></span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#ansible-tasks-__codelineno-4-3"></a><span class="w">  </span><span class="nt">changed_when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#ansible-tasks-__codelineno-4-4"></a><span class="w">  </span><span class="nt">failed_when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<h2 id="ansible-tasks-naming-tasks">Naming tasks</h2>
<p>It is possible to leave off the <em>name</em> for a given task, though it is recommended to provide a description about why something is being done instead. This description is shown when the playbook is run.<br />
Write task names in the imperative (e.g. <em>"Ensure service is running"</em>), this communicates the action of the task. Start with a capital letter.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="2:2"><input checked="checked" id="ansible-tasks-__tabbed_2_1" name="ansible-tasks-__tabbed_2" type="radio" /><input id="ansible-tasks-__tabbed_2_2" name="ansible-tasks-__tabbed_2" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_2_1">Good</label><label for="ansible-tasks-__tabbed_2_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#ansible-tasks-__codelineno-5-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install webserver package</span><span class="w"></span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#ansible-tasks-__codelineno-5-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#ansible-tasks-__codelineno-5-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span><span class="w"></span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#ansible-tasks-__codelineno-5-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#ansible-tasks-__codelineno-6-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#ansible-tasks-__codelineno-6-2"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span><span class="w"></span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#ansible-tasks-__codelineno-6-3"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
</code></pre></div>
Using name parameter, but not starting with capital letter, nor desrcibing the task properly.
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#ansible-tasks-__codelineno-7-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">install package</span><span class="w"></span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#ansible-tasks-__codelineno-7-2"></a><span class="w">  </span><span class="nt">yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#ansible-tasks-__codelineno-7-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span><span class="w"></span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#ansible-tasks-__codelineno-7-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<h3 id="ansible-tasks-prefix-task-names-in-sub-task-files">Prefix task names in sub-task files</h3>
<p>It is a common practice to have <code>tasks/main.yml</code> file including other tasks files, which we’ll call <em>sub-tasks</em> files. Make sure that the tasks' names in these sub-tasks files are prefixed with a shortcut reminding of the sub-tasks file’s name. Especially in a complex role with multiple (sub-)tasks file, it becomes difficult to understand which task belongs to which file.  </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#ansible-tasks-__codelineno-8-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeadm-setup | Install kubeadm, kubelet and kubectl</span><span class="w"></span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#ansible-tasks-__codelineno-8-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#ansible-tasks-__codelineno-8-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#ansible-tasks-__codelineno-8-4"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubelet</span><span class="w"></span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#ansible-tasks-__codelineno-8-5"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeadm</span><span class="w"></span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#ansible-tasks-__codelineno-8-6"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubectl</span><span class="w"></span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#ansible-tasks-__codelineno-8-7"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
</code></pre></div>
<p>The log output will then look like this:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#ansible-tasks-__codelineno-9-1"></a>...
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#ansible-tasks-__codelineno-9-2"></a>TASK <span class="o">[</span>k8s-bootstrap: kubeadm-setup <span class="p">|</span> Install kubeadm, kubelet and kubectl<span class="o">]</span> **********
<a id="__codelineno-9-3" name="__codelineno-9-3" href="#ansible-tasks-__codelineno-9-3"></a>changed: <span class="o">[</span>kubemaster<span class="o">]</span>
<a id="__codelineno-9-4" name="__codelineno-9-4" href="#ansible-tasks-__codelineno-9-4"></a>...
</code></pre></div>
<h2 id="ansible-tasks-fqcn">FQCN</h2>
<p>Use the <em>full qualified collection names (FQCN)</em> for modules, they are supported since Version 2.9 and ensures your tasks are set for the future.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="3:2"><input checked="checked" id="ansible-tasks-__tabbed_3_1" name="ansible-tasks-__tabbed_3" type="radio" /><input id="ansible-tasks-__tabbed_3_2" name="ansible-tasks-__tabbed_3" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_3_1">Good</label><label for="ansible-tasks-__tabbed_3_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#ansible-tasks-__codelineno-10-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install webserver package</span><span class="w"></span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#ansible-tasks-__codelineno-10-2"></a><span class="w">  </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#ansible-tasks-__codelineno-10-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span><span class="w"></span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#ansible-tasks-__codelineno-10-4"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#ansible-tasks-__codelineno-11-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-11-2" name="__codelineno-11-2" href="#ansible-tasks-__codelineno-11-2"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span><span class="w"></span>
<a id="__codelineno-11-3" name="__codelineno-11-3" href="#ansible-tasks-__codelineno-11-3"></a><span class="w">    </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
</div>
<p>In Ansible 2.10, many plugins and modules have migrated to Collections on Ansible Galaxy. Your playbooks should continue to work without any changes. Using the FQCN in your playbooks ensures the explicit and authoritative indicator of which collection to use as some collections may contain duplicate module names.</p>
<h2 id="ansible-tasks-permissions">Permissions</h2>
<p>When using modules like <code>copy</code> or <code>template</code> you can (and should) set permissions for the files/templates deployed with the <code>mode</code> parameter.</p>
<p>For those used to <em>/usr/bin/chmod</em>, remember that modes are actually octal numbers. You must either add a <strong>leading zero</strong> so that Ansible’s YAML parser knows it is an octal number (like <code>0644</code> or <code>01777</code>) or quote it (like <code>"644"</code> or <code>"1777"</code>) so Ansible receives a string and can do its own conversion from string into number.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Giving Ansible a number without following one of these rules will end up with a decimal number which will have unexpected results.</p>
</div>
<div class="tabbed-set tabbed-alternate" data-tabs="4:2"><input checked="checked" id="ansible-tasks-__tabbed_4_1" name="ansible-tasks-__tabbed_4" type="radio" /><input id="ansible-tasks-__tabbed_4_2" name="ansible-tasks-__tabbed_4" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_4_1">Good</label><label for="ansible-tasks-__tabbed_4_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#ansible-tasks-__codelineno-12-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Copy index.html template</span><span class="w"></span>
<a id="__codelineno-12-2" name="__codelineno-12-2" href="#ansible-tasks-__codelineno-12-2"></a><span class="w">  </span><span class="nt">ansible.builtin.template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-12-3" name="__codelineno-12-3" href="#ansible-tasks-__codelineno-12-3"></a><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">welcome.html</span><span class="w"></span>
<a id="__codelineno-12-4" name="__codelineno-12-4" href="#ansible-tasks-__codelineno-12-4"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/www/html/index.html</span><span class="w"></span>
<a id="__codelineno-12-5" name="__codelineno-12-5" href="#ansible-tasks-__codelineno-12-5"></a><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0644</span><span class="w"></span>
<a id="__codelineno-12-6" name="__codelineno-12-6" href="#ansible-tasks-__codelineno-12-6"></a><span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache</span><span class="w"></span>
<a id="__codelineno-12-7" name="__codelineno-12-7" href="#ansible-tasks-__codelineno-12-7"></a><span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache</span><span class="w"></span>
<a id="__codelineno-12-8" name="__codelineno-12-8" href="#ansible-tasks-__codelineno-12-8"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Missing leading zero:
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#ansible-tasks-__codelineno-13-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">copy index</span><span class="w"></span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#ansible-tasks-__codelineno-13-2"></a><span class="w">  </span><span class="nt">template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#ansible-tasks-__codelineno-13-3"></a><span class="w">    </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">welcome.html</span><span class="w"></span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#ansible-tasks-__codelineno-13-4"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/var/www/html/index.html</span><span class="w"></span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#ansible-tasks-__codelineno-13-5"></a><span class="w">    </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">644</span><span class="w"></span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#ansible-tasks-__codelineno-13-6"></a><span class="w">    </span><span class="nt">owner</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache</span><span class="w"></span>
<a id="__codelineno-13-7" name="__codelineno-13-7" href="#ansible-tasks-__codelineno-13-7"></a><span class="w">    </span><span class="nt">group</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apache</span><span class="w"></span>
<a id="__codelineno-13-8" name="__codelineno-13-8" href="#ansible-tasks-__codelineno-13-8"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</code></pre></div>
This leads to these permissions!
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#ansible-tasks-__codelineno-14-1"></a><span class="o">[</span>root@demo /<span class="o">]</span><span class="c1"># ll /var/www/html/</span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#ansible-tasks-__codelineno-14-2"></a>total <span class="m">68</span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#ansible-tasks-__codelineno-14-3"></a>--w----r-T <span class="m">1</span> apache apache <span class="m">67691</span> Nov <span class="m">18</span> <span class="m">14</span>:30 index.html
</code></pre></div></p>
</div>
</div>
</div>
</div>
<h2 id="ansible-tasks-state-definition">State definition</h2>
<p>The <code>state</code> parameter is optional to a lot of modules. Whether <code>state: present</code> or <code>state: absent</code>, it’s always best to leave that parameter in your playbooks to make it clear, especially as some modules support additional states.</p>
<h2 id="ansible-tasks-conditionals">Conditionals</h2>
<p>If the <code>when:</code> condition results in a line that is very long, and is an <code>and</code> expression, then break it into a list of conditions.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="5:2"><input checked="checked" id="ansible-tasks-__tabbed_5_1" name="ansible-tasks-__tabbed_5" type="radio" /><input id="ansible-tasks-__tabbed_5_2" name="ansible-tasks-__tabbed_5" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_5_1">Good</label><label for="ansible-tasks-__tabbed_5_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#ansible-tasks-__codelineno-15-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set motd message for k8s worker node</span><span class="w"></span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#ansible-tasks-__codelineno-15-2"></a><span class="w">  </span><span class="nt">ansible.builtin.copy</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#ansible-tasks-__codelineno-15-3"></a><span class="w">    </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;This</span><span class="nv"> </span><span class="s">host</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">used</span><span class="nv"> </span><span class="s">as</span><span class="nv"> </span><span class="s">k8s</span><span class="nv"> </span><span class="s">worker.\n&quot;</span><span class="w"></span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#ansible-tasks-__codelineno-15-4"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/motd</span><span class="w"></span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#ansible-tasks-__codelineno-15-5"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span>
<a id="__codelineno-15-6" name="__codelineno-15-6" href="#ansible-tasks-__codelineno-15-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inventory_hostname in groups[&#39;kubeworker&#39;]</span><span class="w"></span>
<a id="__codelineno-15-7" name="__codelineno-15-7" href="#ansible-tasks-__codelineno-15-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">kubeadm_join_result.rc == 0</span><span class="w"></span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#ansible-tasks-__codelineno-16-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Set motd message for k8s worker node</span><span class="w"></span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#ansible-tasks-__codelineno-16-2"></a><span class="w">  </span><span class="nt">copy</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#ansible-tasks-__codelineno-16-3"></a><span class="w">    </span><span class="nt">content</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;This</span><span class="nv"> </span><span class="s">host</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">used</span><span class="nv"> </span><span class="s">as</span><span class="nv"> </span><span class="s">k8s</span><span class="nv"> </span><span class="s">worker.\n&quot;</span><span class="w"></span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#ansible-tasks-__codelineno-16-4"></a><span class="w">    </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/motd</span><span class="w"></span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#ansible-tasks-__codelineno-16-5"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">inventory_hostname in groups[&#39;kubeworker&#39;] and kubeadm_join_result.rc == 0</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
</div>
<p>When using conditions on <em>blocks</em>, move the <code>when</code> statement to the top, below the <em>name</em> parameter, to improve readability.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="6:2"><input checked="checked" id="ansible-tasks-__tabbed_6_1" name="ansible-tasks-__tabbed_6" type="radio" /><input id="ansible-tasks-__tabbed_6_2" name="ansible-tasks-__tabbed_6" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_6_1">Good</label><label for="ansible-tasks-__tabbed_6_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#ansible-tasks-__codelineno-17-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install, configure, and start Apache</span><span class="w"></span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#ansible-tasks-__codelineno-17-2"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;distribution&#39;] == &#39;CentOS&#39;</span><span class="w"></span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#ansible-tasks-__codelineno-17-3"></a><span class="w">  </span><span class="nt">block</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-17-4" name="__codelineno-17-4" href="#ansible-tasks-__codelineno-17-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install httpd and memcached</span><span class="w"></span>
<a id="__codelineno-17-5" name="__codelineno-17-5" href="#ansible-tasks-__codelineno-17-5"></a><span class="w">      </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-17-6" name="__codelineno-17-6" href="#ansible-tasks-__codelineno-17-6"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-17-7" name="__codelineno-17-7" href="#ansible-tasks-__codelineno-17-7"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span><span class="w"></span>
<a id="__codelineno-17-8" name="__codelineno-17-8" href="#ansible-tasks-__codelineno-17-8"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">memcached</span><span class="w"></span>
<a id="__codelineno-17-9" name="__codelineno-17-9" href="#ansible-tasks-__codelineno-17-9"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
<a id="__codelineno-17-10" name="__codelineno-17-10" href="#ansible-tasks-__codelineno-17-10"></a>
<a id="__codelineno-17-11" name="__codelineno-17-11" href="#ansible-tasks-__codelineno-17-11"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Apply the foo config template</span><span class="w"></span>
<a id="__codelineno-17-12" name="__codelineno-17-12" href="#ansible-tasks-__codelineno-17-12"></a><span class="w">      </span><span class="nt">ansible.builtin.template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-17-13" name="__codelineno-17-13" href="#ansible-tasks-__codelineno-17-13"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates/src.j2</span><span class="w"></span>
<a id="__codelineno-17-14" name="__codelineno-17-14" href="#ansible-tasks-__codelineno-17-14"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/foo.conf</span><span class="w"></span>
<a id="__codelineno-17-15" name="__codelineno-17-15" href="#ansible-tasks-__codelineno-17-15"></a>
<a id="__codelineno-17-16" name="__codelineno-17-16" href="#ansible-tasks-__codelineno-17-16"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Start service bar and enable it</span><span class="w"></span>
<a id="__codelineno-17-17" name="__codelineno-17-17" href="#ansible-tasks-__codelineno-17-17"></a><span class="w">      </span><span class="nt">ansible.builtin.service</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-17-18" name="__codelineno-17-18" href="#ansible-tasks-__codelineno-17-18"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bar</span><span class="w"></span>
<a id="__codelineno-17-19" name="__codelineno-17-19" href="#ansible-tasks-__codelineno-17-19"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">started</span><span class="w"></span>
<a id="__codelineno-17-20" name="__codelineno-17-20" href="#ansible-tasks-__codelineno-17-20"></a><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#ansible-tasks-__codelineno-18-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install, configure, and start Apache</span><span class="w"></span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#ansible-tasks-__codelineno-18-2"></a><span class="w">  </span><span class="nt">block</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#ansible-tasks-__codelineno-18-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install httpd and memcached</span><span class="w"></span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#ansible-tasks-__codelineno-18-4"></a><span class="w">      </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#ansible-tasks-__codelineno-18-5"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-18-6" name="__codelineno-18-6" href="#ansible-tasks-__codelineno-18-6"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">httpd</span><span class="w"></span>
<a id="__codelineno-18-7" name="__codelineno-18-7" href="#ansible-tasks-__codelineno-18-7"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">memcached</span><span class="w"></span>
<a id="__codelineno-18-8" name="__codelineno-18-8" href="#ansible-tasks-__codelineno-18-8"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
<a id="__codelineno-18-9" name="__codelineno-18-9" href="#ansible-tasks-__codelineno-18-9"></a>
<a id="__codelineno-18-10" name="__codelineno-18-10" href="#ansible-tasks-__codelineno-18-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Apply the foo config template</span><span class="w"></span>
<a id="__codelineno-18-11" name="__codelineno-18-11" href="#ansible-tasks-__codelineno-18-11"></a><span class="w">      </span><span class="nt">ansible.builtin.template</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-18-12" name="__codelineno-18-12" href="#ansible-tasks-__codelineno-18-12"></a><span class="w">        </span><span class="nt">src</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">templates/src.j2</span><span class="w"></span>
<a id="__codelineno-18-13" name="__codelineno-18-13" href="#ansible-tasks-__codelineno-18-13"></a><span class="w">        </span><span class="nt">dest</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/etc/foo.conf</span><span class="w"></span>
<a id="__codelineno-18-14" name="__codelineno-18-14" href="#ansible-tasks-__codelineno-18-14"></a>
<a id="__codelineno-18-15" name="__codelineno-18-15" href="#ansible-tasks-__codelineno-18-15"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Start service bar and enable it</span><span class="w"></span>
<a id="__codelineno-18-16" name="__codelineno-18-16" href="#ansible-tasks-__codelineno-18-16"></a><span class="w">      </span><span class="nt">ansible.builtin.service</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-18-17" name="__codelineno-18-17" href="#ansible-tasks-__codelineno-18-17"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">bar</span><span class="w"></span>
<a id="__codelineno-18-18" name="__codelineno-18-18" href="#ansible-tasks-__codelineno-18-18"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">started</span><span class="w"></span>
<a id="__codelineno-18-19" name="__codelineno-18-19" href="#ansible-tasks-__codelineno-18-19"></a><span class="w">        </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">True</span><span class="w"></span>
<a id="__codelineno-18-20" name="__codelineno-18-20" href="#ansible-tasks-__codelineno-18-20"></a><span class="w">  </span><span class="nt">when</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;distribution&#39;] == &#39;CentOS&#39;</span><span class="w"></span>
</code></pre></div>
</div>
</div>
</div>
</div>
<p>Avoid the use of <code>when: foo_result is changed</code> whenever possible. Use handlers, and, if necessary, handler chains to achieve this same result.</p>
<h2 id="ansible-tasks-loops">Loops</h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Work in Progress</strong> - More description necessary.</p>
</div>
<p>Converting from <code>with_&lt;lookup&gt;</code> to <code>loop</code> is described with a <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_loops.html#migrating-from-with-x-to-loop" target="_blank">Migration Guide</a> in the Ansible documentation</p>
<h3 id="ansible-tasks-limit-loop-output">Limit loop output</h3>
<p>When looping over complex data structures, the console output of your task can be enormous. To limit the displayed output, use the <code>label</code> directive with <code>loop_control</code>. For example, this tasks creates users with multiple parameters in a loop:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#ansible-tasks-__codelineno-19-1"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Create local users</span><span class="w"></span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#ansible-tasks-__codelineno-19-2"></a><span class="w">  </span><span class="nt">user</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#ansible-tasks-__codelineno-19-3"></a><span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.name</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#ansible-tasks-__codelineno-19-4"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.groups</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<a id="__codelineno-19-5" name="__codelineno-19-5" href="#ansible-tasks-__codelineno-19-5"></a><span class="w">    </span><span class="nt">append</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.append</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<a id="__codelineno-19-6" name="__codelineno-19-6" href="#ansible-tasks-__codelineno-19-6"></a><span class="w">    </span><span class="nt">comment</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.comment</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<a id="__codelineno-19-7" name="__codelineno-19-7" href="#ansible-tasks-__codelineno-19-7"></a><span class="w">    </span><span class="nt">generate_ssh_key</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-19-8" name="__codelineno-19-8" href="#ansible-tasks-__codelineno-19-8"></a><span class="w">    </span><span class="nt">password_expire_max</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.password_expire_max</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<a id="__codelineno-19-9" name="__codelineno-19-9" href="#ansible-tasks-__codelineno-19-9"></a><span class="w">  </span><span class="nt">loop</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">user_list</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"></span>
<a id="__codelineno-19-10" name="__codelineno-19-10" href="#ansible-tasks-__codelineno-19-10"></a><span class="w">  </span><span class="nt">loop_control</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-19-11" name="__codelineno-19-11" href="#ansible-tasks-__codelineno-19-11"></a><span class="w">    </span><span class="nt">label</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;{{</span><span class="nv"> </span><span class="s">item.name</span><span class="nv"> </span><span class="s">}}&quot;</span><span class="w"> </span><span class="c1"># (1)!</span><span class="w"></span>
</code></pre></div>
<ol>
<li>Content of variable <code>user_list</code>:
    <div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#ansible-tasks-__codelineno-20-1"></a><span class="nt">user_list</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#ansible-tasks-__codelineno-20-2"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">tgruetz</span><span class="w"></span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#ansible-tasks-__codelineno-20-3"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">admins,docker</span><span class="w"></span>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#ansible-tasks-__codelineno-20-4"></a><span class="w">    </span><span class="nt">append</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span><span class="w"></span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#ansible-tasks-__codelineno-20-5"></a><span class="w">    </span><span class="nt">comment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Tim Grützmacher</span><span class="w"></span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#ansible-tasks-__codelineno-20-6"></a><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/bash</span><span class="w"></span>
<a id="__codelineno-20-7" name="__codelineno-20-7" href="#ansible-tasks-__codelineno-20-7"></a><span class="w">    </span><span class="nt">password_expire_max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">180</span><span class="w"></span>
<a id="__codelineno-20-8" name="__codelineno-20-8" href="#ansible-tasks-__codelineno-20-8"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">joschmi</span><span class="w"></span>
<a id="__codelineno-20-9" name="__codelineno-20-9" href="#ansible-tasks-__codelineno-20-9"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">developers,docker</span><span class="w"></span>
<a id="__codelineno-20-10" name="__codelineno-20-10" href="#ansible-tasks-__codelineno-20-10"></a><span class="w">    </span><span class="nt">append</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-20-11" name="__codelineno-20-11" href="#ansible-tasks-__codelineno-20-11"></a><span class="w">    </span><span class="nt">comment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Jonathan Schmidt</span><span class="w"></span>
<a id="__codelineno-20-12" name="__codelineno-20-12" href="#ansible-tasks-__codelineno-20-12"></a><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/zsh</span><span class="w"></span>
<a id="__codelineno-20-13" name="__codelineno-20-13" href="#ansible-tasks-__codelineno-20-13"></a><span class="w">    </span><span class="nt">password_expire_max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">90</span><span class="w"></span>
<a id="__codelineno-20-14" name="__codelineno-20-14" href="#ansible-tasks-__codelineno-20-14"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">mfrink</span><span class="w"></span>
<a id="__codelineno-20-15" name="__codelineno-20-15" href="#ansible-tasks-__codelineno-20-15"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">developers</span><span class="w"></span>
<a id="__codelineno-20-16" name="__codelineno-20-16" href="#ansible-tasks-__codelineno-20-16"></a><span class="w">    </span><span class="nt">append</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-20-17" name="__codelineno-20-17" href="#ansible-tasks-__codelineno-20-17"></a><span class="w">    </span><span class="nt">comment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Mathias Frink</span><span class="w"></span>
<a id="__codelineno-20-18" name="__codelineno-20-18" href="#ansible-tasks-__codelineno-20-18"></a><span class="w">    </span><span class="nt">shell</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/bin/bash</span><span class="w"></span>
<a id="__codelineno-20-19" name="__codelineno-20-19" href="#ansible-tasks-__codelineno-20-19"></a><span class="w">    </span><span class="nt">password_expire_max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">90</span><span class="w"></span>
</code></pre></div></li>
</ol>
<p>Running the playbook results in the following task output, only the content of the <em>name</em> parameter is shown instead of all key-value pairs in the list item.</p>
<div class="tabbed-set tabbed-alternate" data-tabs="7:2"><input checked="checked" id="ansible-tasks-__tabbed_7_1" name="ansible-tasks-__tabbed_7" type="radio" /><input id="ansible-tasks-__tabbed_7_2" name="ansible-tasks-__tabbed_7" type="radio" /><div class="tabbed-labels"><label for="ansible-tasks-__tabbed_7_1">Good</label><label for="ansible-tasks-__tabbed_7_2">Bad</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition good-practice-no-title">
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#ansible-tasks-__codelineno-21-1"></a>TASK <span class="o">[</span>common : Create <span class="nb">local</span> users<span class="o">]</span> *********************************************
<a id="__codelineno-21-2" name="__codelineno-21-2" href="#ansible-tasks-__codelineno-21-2"></a>Friday <span class="m">18</span> November <span class="m">2022</span>  <span class="m">12</span>:18:01 +0100 <span class="o">(</span><span class="m">0</span>:00:01.955<span class="o">)</span>       <span class="m">0</span>:00:03.933 *******
<a id="__codelineno-21-3" name="__codelineno-21-3" href="#ansible-tasks-__codelineno-21-3"></a>changed: <span class="o">[</span>demo<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=</span>tgruetz<span class="o">)</span>
<a id="__codelineno-21-4" name="__codelineno-21-4" href="#ansible-tasks-__codelineno-21-4"></a>changed: <span class="o">[</span>demo<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=</span>joschmi<span class="o">)</span>
<a id="__codelineno-21-5" name="__codelineno-21-5" href="#ansible-tasks-__codelineno-21-5"></a>changed: <span class="o">[</span>demo<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">=</span>mfrink<span class="o">)</span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition bad-practice-no-title">
<p>Not using the <code>label</code> in the <code>loop_control</code> dictionary results in a very long output:
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#ansible-tasks-__codelineno-22-1"></a>TASK <span class="o">[</span>common : Create <span class="nb">local</span> users<span class="o">]</span> *********************************************
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#ansible-tasks-__codelineno-22-2"></a>Friday <span class="m">18</span> November <span class="m">2022</span>  <span class="m">12</span>:22:40 +0100 <span class="o">(</span><span class="m">0</span>:00:01.512<span class="o">)</span>       <span class="m">0</span>:00:03.609 *******
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#ansible-tasks-__codelineno-22-3"></a>changed: <span class="o">[</span>demo<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">={</span><span class="s1">&#39;name&#39;</span>: <span class="s1">&#39;tgruetz&#39;</span>, <span class="s1">&#39;groups&#39;</span>: <span class="s1">&#39;admins,docker&#39;</span>, <span class="s1">&#39;append&#39;</span>: False, <span class="s1">&#39;comment&#39;</span>: <span class="s1">&#39;Tim Grützmacher&#39;</span>, <span class="s1">&#39;shell&#39;</span>: <span class="s1">&#39;/bin/bash&#39;</span>, <span class="s1">&#39;password_expire_max&#39;</span>: <span class="m">90</span><span class="o">})</span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#ansible-tasks-__codelineno-22-4"></a>changed: <span class="o">[</span>demo<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">={</span><span class="s1">&#39;name&#39;</span>: <span class="s1">&#39;joschmi&#39;</span>, <span class="s1">&#39;groups&#39;</span>: <span class="s1">&#39;developers,docker&#39;</span>, <span class="s1">&#39;append&#39;</span>: True, <span class="s1">&#39;comment&#39;</span>: <span class="s1">&#39;Jonathan Schmidt&#39;</span>, <span class="s1">&#39;shell&#39;</span>: <span class="s1">&#39;/bin/zsh&#39;</span>, <span class="s1">&#39;password_expire_max&#39;</span>: <span class="m">90</span><span class="o">})</span>
<a id="__codelineno-22-5" name="__codelineno-22-5" href="#ansible-tasks-__codelineno-22-5"></a>changed: <span class="o">[</span>demo<span class="o">]</span> <span class="o">=</span>&gt; <span class="o">(</span><span class="nv">item</span><span class="o">={</span><span class="s1">&#39;name&#39;</span>: <span class="s1">&#39;mfrink&#39;</span>, <span class="s1">&#39;groups&#39;</span>: <span class="s1">&#39;developers&#39;</span>, <span class="s1">&#39;append&#39;</span>: True, <span class="s1">&#39;comment&#39;</span>: <span class="s1">&#39;Mathias Frink&#39;</span>, <span class="s1">&#39;shell&#39;</span>: <span class="s1">&#39;/bin/bash&#39;</span>, <span class="s1">&#39;password_expire_max&#39;</span>: <span class="m">90</span><span class="o">})</span>
</code></pre></div></p>
</div>
</div>
</div>
</div>
<h2 id="ansible-tasks-filter">Filter</h2>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Work in Progress</strong> - More description necessary.</p>
</div></section><h1 class='nav-section-title-end'>Ended: Ansible</h1>
                        <h1 class='nav-section-title' id='section-ansible-development'>
                            Ansible Development <a class='headerlink' href='#section-ansible-development' title='Permanent link'>↵</a>
                        </h1>
                        <section class="print-page" id="development"><h1 id="development-development">Development</h1>
<p>This topic is split into three main sections, each section covers a different additional tool to consider when <em>developing</em> your Ansible content.</p>
<ul>
<li><a href="#development-linting"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M9.585.52a2.678 2.678 0 0 0-3.17 0l-.928.68a1.178 1.178 0 0 1-.518.215L3.83 1.59a2.678 2.678 0 0 0-2.24 2.24l-.175 1.14a1.178 1.178 0 0 1-.215.518l-.68.928a2.678 2.678 0 0 0 0 3.17l.68.928c.113.153.186.33.215.518l.175 1.138a2.678 2.678 0 0 0 2.24 2.24l1.138.175c.187.029.365.102.518.215l.928.68a2.678 2.678 0 0 0 3.17 0l.928-.68a1.17 1.17 0 0 1 .518-.215l1.138-.175a2.678 2.678 0 0 0 2.241-2.241l.175-1.138c.029-.187.102-.365.215-.518l.68-.928a2.678 2.678 0 0 0 0-3.17l-.68-.928a1.179 1.179 0 0 1-.215-.518L14.41 3.83a2.678 2.678 0 0 0-2.24-2.24l-1.138-.175a1.179 1.179 0 0 1-.518-.215L9.585.52zM7.303 1.728c.415-.305.98-.305 1.394 0l.928.68c.348.256.752.423 1.18.489l1.136.174c.51.078.909.478.987.987l.174 1.137c.066.427.233.831.489 1.18l.68.927c.305.415.305.98 0 1.394l-.68.928a2.678 2.678 0 0 0-.489 1.18l-.174 1.136a1.178 1.178 0 0 1-.987.987l-1.137.174a2.678 2.678 0 0 0-1.18.489l-.927.68c-.415.305-.98.305-1.394 0l-.928-.68a2.678 2.678 0 0 0-1.18-.489l-1.136-.174a1.178 1.178 0 0 1-.987-.987l-.174-1.137a2.678 2.678 0 0 0-.489-1.18l-.68-.927a1.178 1.178 0 0 1 0-1.394l.68-.928c.256-.348.423-.752.489-1.18l.174-1.136c.078-.51.478-.909.987-.987l1.137-.174a2.678 2.678 0 0 0 1.18-.489l.927-.68zM11.28 6.78a.75.75 0 0 0-1.06-1.06L7 8.94 5.78 7.72a.75.75 0 0 0-1.06 1.06l1.75 1.75a.75.75 0 0 0 1.06 0l3.75-3.75z"/></svg></span> &nbsp; Linting</a> - Installation and usage of the community backed Ansible Best Practice checker</li>
<li><a href="#development-testing"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M5.75.75A.75.75 0 0 1 6.5 0h3a.75.75 0 0 1 0 1.5h-.75v1l-.001.041a6.718 6.718 0 0 1 3.464 1.435l.007-.006.75-.75a.75.75 0 1 1 1.06 1.06l-.75.75-.006.007a6.75 6.75 0 1 1-10.548 0L2.72 5.03l-.75-.75a.75.75 0 0 1 1.06-1.06l.75.75.007.006A6.718 6.718 0 0 1 7.25 2.541a.756.756 0 0 1 0-.041v-1H6.5a.75.75 0 0 1-.75-.75zM8 14.5A5.25 5.25 0 1 0 8 4a5.25 5.25 0 0 0 0 10.5zm.389-6.7 1.33-1.33a.75.75 0 1 1 1.061 1.06L9.45 8.861A1.502 1.502 0 0 1 8 10.75a1.5 1.5 0 1 1 .389-2.95z"/></svg></span> &nbsp; Testing</a> - How to test your Ansible content during development</li>
<li><a href="#development-testing"><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10.276 3.09a.25.25 0 0 1 .192-.09h.782a.25.25 0 0 1 .25.25v8.5a.25.25 0 0 1-.25.25h-.782a.25.25 0 0 1-.192-.09l-.95-1.14a.75.75 0 0 0-.483-.264l-3.124-.39a.25.25 0 0 1-.219-.249V5.133a.25.25 0 0 1 .219-.248l3.124-.39a.75.75 0 0 0 .483-.265l.95-1.14zM4 8v1.867a1.75 1.75 0 0 0 1.533 1.737l2.83.354.761.912c.332.4.825.63 1.344.63h.782A1.75 1.75 0 0 0 13 11.75V11h2.25a.75.75 0 0 0 0-1.5H13v-4h2.25a.75.75 0 0 0 0-1.5H13v-.75a1.75 1.75 0 0 0-1.75-1.75h-.782c-.519 0-1.012.23-1.344.63l-.76.913-2.831.353A1.75 1.75 0 0 0 4 5.133V6.5H2.5A2.5 2.5 0 0 0 0 9v5.25a.75.75 0 0 0 1.5 0V9a1 1 0 0 1 1-1H4z"/></svg></span> &nbsp; Extending</a> - Create your own custom modules and plugins</li>
</ul>
<h2 id="development-tools">Tools</h2>
<p>Each section above make use of an additional tool to support you during your Ansible content development, in most cases the standalone installation, as well as a custom container-based installation and usage method is described.  </p>
<p>The Ansible community provides a Container image bundling all the tools described in the sections above.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#development-__codelineno-0-1"></a>docker pull quay.io/ansible/creator-ee
</code></pre></div>
<p>For example you could output the version of the installed tools like this:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#development-__codelineno-1-1"></a>docker run --rm quay.io/ansible/creator-ee ansible-lint --version
</code></pre></div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#development-__codelineno-2-1"></a>docker run --rm quay.io/ansible/creator-ee molecule --version
</code></pre></div>
<p>Take a look into the respective sections for more information and additional usage instructions.</p></section><section class="print-page" id="development-linting"><h1 id="development-linting-linting">Linting</h1>
<p><a href="https://ansible-lint.readthedocs.io/" target="_blank"><em>Ansible Lint</em></a> is a best-practice checker for Ansible, maintained by the Ansible community.</p>
<h2 id="development-linting-installation">Installation</h2>
<p>Ansible Lint is installed through the Python packet manager:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><em>Ansible Lint</em> always needs <em>Ansible</em> itself</p>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#development-linting-__codelineno-0-1"></a>pip3 install ansible-lint
</code></pre></div>
<h2 id="development-linting-usage">Usage</h2>
<p>The usage is fairly simple, just run <code>ansible-lint &lt;your-playbook&gt;</code>.<br />
The tool will check your playbook for best-practices, it traverses your playbook and will lint all included playbooks and roles.</p>
<p>Take a look at the <a href="https://ansible-lint.readthedocs.io/" target="_blank"><em>ansible-lint documentation</em></a> for additional information.</p>
<h3 id="development-linting-lint-in-docker-image">Lint in Docker Image</h3>
<p>The following <em>Dockerfile</em> can be used to build a Docker Container image which bundles <em>ansible-lint</em> and its dependencies:</p>
<details class="example">
<summary>Dockerfile</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#development-linting-__codelineno-1-1"></a><span class="k">FROM</span><span class="w"> </span><span class="s">python:3.9-slim</span>
<a id="__codelineno-1-2" name="__codelineno-1-2" href="#development-linting-__codelineno-1-2"></a>
<a id="__codelineno-1-3" name="__codelineno-1-3" href="#development-linting-__codelineno-1-3"></a><span class="c"># Enable colored output</span>
<a id="__codelineno-1-4" name="__codelineno-1-4" href="#development-linting-__codelineno-1-4"></a><span class="k">ENV</span><span class="w"> </span>TERM xterm-256color
<a id="__codelineno-1-5" name="__codelineno-1-5" href="#development-linting-__codelineno-1-5"></a>
<a id="__codelineno-1-6" name="__codelineno-1-6" href="#development-linting-__codelineno-1-6"></a><span class="c"># Defining Ansible environment variable to not output depreaction warnings. This is not useful in the linting container.</span>
<a id="__codelineno-1-7" name="__codelineno-1-7" href="#development-linting-__codelineno-1-7"></a><span class="c"># This overwrites the value in the ansible.cfg from volume mount</span>
<a id="__codelineno-1-8" name="__codelineno-1-8" href="#development-linting-__codelineno-1-8"></a><span class="k">ENV</span><span class="w"> </span><span class="nv">ANSIBLE_DEPRECATION_WARNINGS</span><span class="o">=</span><span class="nb">false</span>
<a id="__codelineno-1-9" name="__codelineno-1-9" href="#development-linting-__codelineno-1-9"></a>
<a id="__codelineno-1-10" name="__codelineno-1-10" href="#development-linting-__codelineno-1-10"></a><span class="c"># Install requirements.</span>
<a id="__codelineno-1-11" name="__codelineno-1-11" href="#development-linting-__codelineno-1-11"></a><span class="k">RUN</span><span class="w"> </span>apt-get update <span class="o">&amp;&amp;</span> apt-get install -y <span class="se">\</span>
<a id="__codelineno-1-12" name="__codelineno-1-12" href="#development-linting-__codelineno-1-12"></a>  git <span class="se">\</span>
<a id="__codelineno-1-13" name="__codelineno-1-13" href="#development-linting-__codelineno-1-13"></a>  <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/*
<a id="__codelineno-1-14" name="__codelineno-1-14" href="#development-linting-__codelineno-1-14"></a>
<a id="__codelineno-1-15" name="__codelineno-1-15" href="#development-linting-__codelineno-1-15"></a><span class="c"># Update pip</span>
<a id="__codelineno-1-16" name="__codelineno-1-16" href="#development-linting-__codelineno-1-16"></a><span class="k">RUN</span><span class="w"> </span>python3 -m pip install --no-cache-dir --no-compile --upgrade pip
<a id="__codelineno-1-17" name="__codelineno-1-17" href="#development-linting-__codelineno-1-17"></a>
<a id="__codelineno-1-18" name="__codelineno-1-18" href="#development-linting-__codelineno-1-18"></a><span class="c"># Install ansible-lint and dependencies</span>
<a id="__codelineno-1-19" name="__codelineno-1-19" href="#development-linting-__codelineno-1-19"></a><span class="k">RUN</span><span class="w"> </span>pip3 install --no-cache-dir --no-compile ansible-lint ansible yamllint
<a id="__codelineno-1-20" name="__codelineno-1-20" href="#development-linting-__codelineno-1-20"></a>
<a id="__codelineno-1-21" name="__codelineno-1-21" href="#development-linting-__codelineno-1-21"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/data</span>
<a id="__codelineno-1-22" name="__codelineno-1-22" href="#development-linting-__codelineno-1-22"></a><span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ansible-lint&quot;</span><span class="p">]</span>
<a id="__codelineno-1-23" name="__codelineno-1-23" href="#development-linting-__codelineno-1-23"></a><span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;--version&quot;</span><span class="p">]</span>
</code></pre></div>
</details>
<p>Build the container image, the command expects that the <em>Dockerfile</em> is present in the current directory:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#development-linting-__codelineno-2-1"></a>docker build -t ansible-lint .
</code></pre></div>
<p>After building the image, the image can be used. Inside of the Ansible project directory, run this command (e.g. this lints the <code>site.yml</code> playbook).
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#development-linting-__codelineno-3-1"></a>docker run --rm -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/data ansible-lint site.yml
</code></pre></div></p>
<p>The output for example is something like this, <em>ansible-lint</em> reports a warning regarding unnecessary white-spaces in a line, as well as an error regarding unset file permissions (fix could be setting <code>mode: 0644</code> in the task):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#development-linting-__codelineno-4-1"></a>$ docker run --rm -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/data ansible-lint site.yml 
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#development-linting-__codelineno-4-2"></a>WARNING  Overriding detected file kind <span class="s1">&#39;yaml&#39;</span> with <span class="s1">&#39;playbook&#39;</span> <span class="k">for</span> given positional argument: site.yml
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#development-linting-__codelineno-4-3"></a>WARNING  Listing <span class="m">2</span> violation<span class="o">(</span>s<span class="o">)</span> that are fatal
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#development-linting-__codelineno-4-4"></a>yaml: trailing spaces <span class="o">(</span>trailing-spaces<span class="o">)</span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#development-linting-__codelineno-4-5"></a>roles/network/tasks/cacheserve-loopback-interface.yml:19
<a id="__codelineno-4-6" name="__codelineno-4-6" href="#development-linting-__codelineno-4-6"></a>
<a id="__codelineno-4-7" name="__codelineno-4-7" href="#development-linting-__codelineno-4-7"></a>risky-file-permissions: File permissions <span class="nb">unset</span> or incorrect
<a id="__codelineno-4-8" name="__codelineno-4-8" href="#development-linting-__codelineno-4-8"></a>roles/network/tasks/cacheserve-loopback-interface.yml:43 Task/Handler: Deploy loopback interface config <span class="k">for</span> Cacheserve
<a id="__codelineno-4-9" name="__codelineno-4-9" href="#development-linting-__codelineno-4-9"></a>
<a id="__codelineno-4-10" name="__codelineno-4-10" href="#development-linting-__codelineno-4-10"></a>You can skip specific rules or tags by adding them to your configuration file:
<a id="__codelineno-4-11" name="__codelineno-4-11" href="#development-linting-__codelineno-4-11"></a><span class="c1"># .ansible-lint</span>
<a id="__codelineno-4-12" name="__codelineno-4-12" href="#development-linting-__codelineno-4-12"></a>warn_list:  <span class="c1"># or &#39;skip_list&#39; to silence them completely</span>
<a id="__codelineno-4-13" name="__codelineno-4-13" href="#development-linting-__codelineno-4-13"></a>  - experimental  <span class="c1"># all rules tagged as experimental</span>
<a id="__codelineno-4-14" name="__codelineno-4-14" href="#development-linting-__codelineno-4-14"></a>  - yaml  <span class="c1"># Violations reported by yamllint</span>
<a id="__codelineno-4-15" name="__codelineno-4-15" href="#development-linting-__codelineno-4-15"></a>
<a id="__codelineno-4-16" name="__codelineno-4-16" href="#development-linting-__codelineno-4-16"></a>Finished with <span class="m">1</span> failure<span class="o">(</span>s<span class="o">)</span>, <span class="m">1</span> warning<span class="o">(</span>s<span class="o">)</span> on <span class="m">460</span> files.
</code></pre></div>
<p>To simplify the usage, consider adding an <em>alias</em> to your <code>.bashrc</code>, e.g.:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#development-linting-__codelineno-5-1"></a><span class="c1"># .bashrc</span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#development-linting-__codelineno-5-2"></a><span class="c1"># User specific aliases and functions</span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#development-linting-__codelineno-5-3"></a><span class="nb">alias</span> <span class="nv">lint</span><span class="o">=</span><span class="s2">&quot;docker run --rm -v </span><span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span><span class="s2">:/data ansible-lint&quot;</span>
</code></pre></div>
<p>After running <code>source ~/.bashrc</code> you can use the alias:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#development-linting-__codelineno-6-1"></a>lint site.yml
</code></pre></div>
<h2 id="development-linting-automated-linting">Automated Linting</h2>
<p>Lining can and should be done automatically, this way you can't forget to check your playbook for best practices. This can be done on multiple levels, either locally as part of your Git workflow, as well as with a pipeline in your remote repository.</p>
<h3 id="development-linting-git-pre-commit-hook">Git pre-commit hook</h3>
<p>A nice way to check for best practices during your Git worflow is the usage of a <em>pre-commit</em> hook. These hooks can be simple bash script, which are run whenever you are commiting changes locally to the staging area.</p>
<p>The following script can be used as a starting point, it uses <em>ansible-lint</em> from inside a container (see <a href="#development-linting-lint-in-docker-image">Lint in Docker Image</a> how to build it) and also checks for unencrypted files in your commit. </p>
<details class="example">
<summary>.git/hooks/pre-commit</summary>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#development-linting-__codelineno-7-1"></a><span class="ch">#!/bin/bash</span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#development-linting-__codelineno-7-2"></a><span class="c1">#</span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#development-linting-__codelineno-7-3"></a><span class="c1"># File should be .git/hooks/pre-commit and executable</span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#development-linting-__codelineno-7-4"></a><span class="c1">#</span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#development-linting-__codelineno-7-5"></a>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#development-linting-__codelineno-7-6"></a><span class="c1"># Pre-commit hook that runs ansible-lint Container for best practice checking</span>
<a id="__codelineno-7-7" name="__codelineno-7-7" href="#development-linting-__codelineno-7-7"></a><span class="c1"># If lint has errors, commit will fail with an error message.</span>
<a id="__codelineno-7-8" name="__codelineno-7-8" href="#development-linting-__codelineno-7-8"></a><span class="k">if</span> <span class="o">[[</span> ! <span class="k">$(</span>docker inspect ansible-lint<span class="k">)</span> <span class="o">]]</span> <span class="p">;</span> <span class="k">then</span>
<a id="__codelineno-7-9" name="__codelineno-7-9" href="#development-linting-__codelineno-7-9"></a>  <span class="nb">echo</span> <span class="s2">&quot;# DOCKER IMAGE NOT FOUND&quot;</span>
<a id="__codelineno-7-10" name="__codelineno-7-10" href="#development-linting-__codelineno-7-10"></a>  <span class="nb">echo</span> <span class="s2">&quot;# Build the Docker image from the Gitlab project &#39;ansible-lint Docker Image&#39;.&quot;</span>
<a id="__codelineno-7-11" name="__codelineno-7-11" href="#development-linting-__codelineno-7-11"></a>  <span class="nb">echo</span> <span class="s2">&quot;# No linting is done!&quot;</span>
<a id="__codelineno-7-12" name="__codelineno-7-12" href="#development-linting-__codelineno-7-12"></a><span class="k">else</span>
<a id="__codelineno-7-13" name="__codelineno-7-13" href="#development-linting-__codelineno-7-13"></a>  <span class="nb">echo</span> <span class="s2">&quot;# Running &#39;ansible-lint&#39; against commit, this takes some time ...&quot;</span>
<a id="__codelineno-7-14" name="__codelineno-7-14" href="#development-linting-__codelineno-7-14"></a>  <span class="c1"># Getting all files currently staged and storing them in variable</span>
<a id="__codelineno-7-15" name="__codelineno-7-15" href="#development-linting-__codelineno-7-15"></a>  <span class="nv">FILES_TO_LINT</span><span class="o">=</span><span class="k">$(</span>git diff --cached --name-only<span class="k">)</span>
<a id="__codelineno-7-16" name="__codelineno-7-16" href="#development-linting-__codelineno-7-16"></a>  <span class="c1"># Running with shared profile, see https://ansible-lint.readthedocs.io/profiles/</span>
<a id="__codelineno-7-17" name="__codelineno-7-17" href="#development-linting-__codelineno-7-17"></a>  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$FILES_TO_LINT</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
<a id="__codelineno-7-18" name="__codelineno-7-18" href="#development-linting-__codelineno-7-18"></a>    <span class="nb">echo</span> <span class="s2">&quot;# No files linting found. Add files to staging area with &#39;git add &lt;file&gt;&#39;.&quot;</span>
<a id="__codelineno-7-19" name="__codelineno-7-19" href="#development-linting-__codelineno-7-19"></a>  <span class="k">else</span>
<a id="__codelineno-7-20" name="__codelineno-7-20" href="#development-linting-__codelineno-7-20"></a>    docker run --rm -v <span class="k">$(</span><span class="nb">pwd</span><span class="k">)</span>:/data ansible-lint <span class="nv">$FILES_TO_LINT</span>
<a id="__codelineno-7-21" name="__codelineno-7-21" href="#development-linting-__codelineno-7-21"></a>    <span class="k">if</span> <span class="o">[</span> ! <span class="nv">$?</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
<a id="__codelineno-7-22" name="__codelineno-7-22" href="#development-linting-__codelineno-7-22"></a>      <span class="nb">echo</span> <span class="s2">&quot;# COMMIT REJECTED&quot;</span>
<a id="__codelineno-7-23" name="__codelineno-7-23" href="#development-linting-__codelineno-7-23"></a>      <span class="nb">echo</span> <span class="s2">&quot;# Please fix the shown linting errors&quot;</span>
<a id="__codelineno-7-24" name="__codelineno-7-24" href="#development-linting-__codelineno-7-24"></a>      <span class="nb">echo</span> <span class="s2">&quot;#   (or force the commit with &#39;--no-verify&#39;).&quot;</span>
<a id="__codelineno-7-25" name="__codelineno-7-25" href="#development-linting-__codelineno-7-25"></a>      <span class="nb">exit</span> <span class="m">1</span><span class="p">;</span>
<a id="__codelineno-7-26" name="__codelineno-7-26" href="#development-linting-__codelineno-7-26"></a>    <span class="k">fi</span>
<a id="__codelineno-7-27" name="__codelineno-7-27" href="#development-linting-__codelineno-7-27"></a>  <span class="k">fi</span>
<a id="__codelineno-7-28" name="__codelineno-7-28" href="#development-linting-__codelineno-7-28"></a><span class="k">fi</span>
<a id="__codelineno-7-29" name="__codelineno-7-29" href="#development-linting-__codelineno-7-29"></a>
<a id="__codelineno-7-30" name="__codelineno-7-30" href="#development-linting-__codelineno-7-30"></a><span class="c1"># Pre-commit hook that verifies if all files containing &#39;vault&#39; in the name</span>
<a id="__codelineno-7-31" name="__codelineno-7-31" href="#development-linting-__codelineno-7-31"></a><span class="c1"># are encrypted.</span>
<a id="__codelineno-7-32" name="__codelineno-7-32" href="#development-linting-__codelineno-7-32"></a><span class="c1"># If not, commit will fail with an error message.</span>
<a id="__codelineno-7-33" name="__codelineno-7-33" href="#development-linting-__codelineno-7-33"></a><span class="c1"># Finds all files in &#39;inventory&#39; folder or &#39;files&#39; folder in roles. Files in other</span>
<a id="__codelineno-7-34" name="__codelineno-7-34" href="#development-linting-__codelineno-7-34"></a><span class="c1"># locations are not recognized!</span>
<a id="__codelineno-7-35" name="__codelineno-7-35" href="#development-linting-__codelineno-7-35"></a><span class="nv">FILES_PATTERN</span><span class="o">=</span><span class="s1">&#39;(inventory.*vault.*)|(files.*vault.*)&#39;</span>
<a id="__codelineno-7-36" name="__codelineno-7-36" href="#development-linting-__codelineno-7-36"></a><span class="nv">REQUIRED</span><span class="o">=</span><span class="s1">&#39;ANSIBLE_VAULT&#39;</span>
<a id="__codelineno-7-37" name="__codelineno-7-37" href="#development-linting-__codelineno-7-37"></a>
<a id="__codelineno-7-38" name="__codelineno-7-38" href="#development-linting-__codelineno-7-38"></a><span class="nv">EXIT_STATUS</span><span class="o">=</span><span class="m">0</span>
<a id="__codelineno-7-39" name="__codelineno-7-39" href="#development-linting-__codelineno-7-39"></a><span class="nv">wipe</span><span class="o">=</span><span class="s2">&quot;\033[1m\033[0m&quot;</span>
<a id="__codelineno-7-40" name="__codelineno-7-40" href="#development-linting-__codelineno-7-40"></a><span class="nv">yellow</span><span class="o">=</span><span class="s1">&#39;\033[1;33m&#39;</span>
<a id="__codelineno-7-41" name="__codelineno-7-41" href="#development-linting-__codelineno-7-41"></a><span class="c1"># carriage return hack. Leave it on 2 lines.</span>
<a id="__codelineno-7-42" name="__codelineno-7-42" href="#development-linting-__codelineno-7-42"></a><span class="nv">cr</span><span class="o">=</span><span class="s1">&#39;</span>
<a id="__codelineno-7-43" name="__codelineno-7-43" href="#development-linting-__codelineno-7-43"></a><span class="s1">&#39;</span>
<a id="__codelineno-7-44" name="__codelineno-7-44" href="#development-linting-__codelineno-7-44"></a><span class="nb">echo</span> <span class="s2">&quot;# Checking for unencrypted vault files in commit ...&quot;</span>
<a id="__codelineno-7-45" name="__codelineno-7-45" href="#development-linting-__codelineno-7-45"></a><span class="k">for</span> f <span class="k">in</span> <span class="k">$(</span>git diff --cached --name-only <span class="p">|</span> grep -E <span class="nv">$FILES_PATTERN</span><span class="k">)</span>
<a id="__codelineno-7-46" name="__codelineno-7-46" href="#development-linting-__codelineno-7-46"></a><span class="k">do</span>
<a id="__codelineno-7-47" name="__codelineno-7-47" href="#development-linting-__codelineno-7-47"></a>  <span class="c1"># test for the presence of the required bit.</span>
<a id="__codelineno-7-48" name="__codelineno-7-48" href="#development-linting-__codelineno-7-48"></a>  <span class="nv">MATCH</span><span class="o">=</span><span class="sb">`</span>head -n1 <span class="nv">$f</span> <span class="p">|</span> grep --no-messages <span class="nv">$REQUIRED</span><span class="sb">`</span>
<a id="__codelineno-7-49" name="__codelineno-7-49" href="#development-linting-__codelineno-7-49"></a>  <span class="k">if</span> <span class="o">[</span> ! <span class="nv">$MATCH</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
<a id="__codelineno-7-50" name="__codelineno-7-50" href="#development-linting-__codelineno-7-50"></a>    <span class="c1"># Build the list of unencrypted files if any</span>
<a id="__codelineno-7-51" name="__codelineno-7-51" href="#development-linting-__codelineno-7-51"></a>    <span class="nv">UNENCRYPTED_FILES</span><span class="o">=</span><span class="s2">&quot;</span><span class="nv">$f$cr$UNENCRYPTED_FILES</span><span class="s2">&quot;</span>
<a id="__codelineno-7-52" name="__codelineno-7-52" href="#development-linting-__codelineno-7-52"></a>    <span class="nv">EXIT_STATUS</span><span class="o">=</span><span class="m">1</span>
<a id="__codelineno-7-53" name="__codelineno-7-53" href="#development-linting-__codelineno-7-53"></a>  <span class="k">fi</span>
<a id="__codelineno-7-54" name="__codelineno-7-54" href="#development-linting-__codelineno-7-54"></a><span class="k">done</span>
<a id="__codelineno-7-55" name="__codelineno-7-55" href="#development-linting-__codelineno-7-55"></a><span class="k">if</span> <span class="o">[</span> ! <span class="nv">$EXIT_STATUS</span> <span class="o">=</span> <span class="m">0</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
<a id="__codelineno-7-56" name="__codelineno-7-56" href="#development-linting-__codelineno-7-56"></a>  <span class="nb">echo</span> <span class="s1">&#39;# COMMIT REJECTED&#39;</span>
<a id="__codelineno-7-57" name="__codelineno-7-57" href="#development-linting-__codelineno-7-57"></a>  <span class="nb">echo</span> <span class="s1">&#39;# Looks like unencrypted ansible-vault files are part of the commit:&#39;</span>
<a id="__codelineno-7-58" name="__codelineno-7-58" href="#development-linting-__codelineno-7-58"></a>  <span class="nb">echo</span> <span class="s1">&#39;#&#39;</span>
<a id="__codelineno-7-59" name="__codelineno-7-59" href="#development-linting-__codelineno-7-59"></a>  <span class="k">while</span> <span class="nb">read</span> -r line<span class="p">;</span> <span class="k">do</span>
<a id="__codelineno-7-60" name="__codelineno-7-60" href="#development-linting-__codelineno-7-60"></a>    <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$line</span><span class="s2">&quot;</span> <span class="o">]</span> <span class="p">;</span> <span class="k">then</span>
<a id="__codelineno-7-61" name="__codelineno-7-61" href="#development-linting-__codelineno-7-61"></a>      <span class="nb">echo</span> -e <span class="s2">&quot;#\t</span><span class="si">${</span><span class="nv">yellow</span><span class="si">}</span><span class="s2">unencrypted:   </span><span class="nv">$line</span><span class="si">${</span><span class="nv">wipe</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-7-62" name="__codelineno-7-62" href="#development-linting-__codelineno-7-62"></a>    <span class="k">fi</span>
<a id="__codelineno-7-63" name="__codelineno-7-63" href="#development-linting-__codelineno-7-63"></a>  <span class="k">done</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">&quot;</span><span class="nv">$UNENCRYPTED_FILES</span><span class="s2">&quot;</span>
<a id="__codelineno-7-64" name="__codelineno-7-64" href="#development-linting-__codelineno-7-64"></a>  <span class="nb">echo</span> <span class="s1">&#39;#&#39;</span>
<a id="__codelineno-7-65" name="__codelineno-7-65" href="#development-linting-__codelineno-7-65"></a>  <span class="nb">echo</span> <span class="s2">&quot;# Please encrypt them with &#39;ansible-vault encrypt &lt;file&gt;&#39;&quot;</span>
<a id="__codelineno-7-66" name="__codelineno-7-66" href="#development-linting-__codelineno-7-66"></a>  <span class="nb">echo</span> <span class="s2">&quot;#   (or force the commit with &#39;--no-verify&#39;).&quot;</span>
<a id="__codelineno-7-67" name="__codelineno-7-67" href="#development-linting-__codelineno-7-67"></a>  <span class="nb">exit</span> <span class="nv">$EXIT_STATUS</span>
<a id="__codelineno-7-68" name="__codelineno-7-68" href="#development-linting-__codelineno-7-68"></a><span class="k">fi</span>
<a id="__codelineno-7-69" name="__codelineno-7-69" href="#development-linting-__codelineno-7-69"></a><span class="nb">exit</span> <span class="nv">$EXIT_STATUS</span>
</code></pre></div>
</details>
<h3 id="development-linting-ci-pipeline">CI Pipeline</h3>
<p>Running <em>ansible-lint</em> through a CI pipeline automatically when merging changes to the Git repository is <strong>highly advisable</strong>.</p>
<p>A possible pipeline in Gitlab may look like this, utilizing the container image above:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#development-linting-__codelineno-8-1"></a><span class="nt">workflow</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#development-linting-__codelineno-8-2"></a><span class="w">  </span><span class="nt">rules</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#development-linting-__codelineno-8-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$CI_PIPELINE_SOURCE == &#39;merge_request_event&#39;</span><span class="w"></span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#development-linting-__codelineno-8-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$CI_PIPELINE_SOURCE == &#39;web&#39;</span><span class="w"></span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#development-linting-__codelineno-8-5"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">if</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">$CI_PIPELINE_SOURCE == &#39;schedule&#39;</span><span class="w"></span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#development-linting-__codelineno-8-6"></a>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#development-linting-__codelineno-8-7"></a><span class="nt">variables</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#development-linting-__codelineno-8-8"></a><span class="w">  </span><span class="nt">GIT_STRATEGY</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">clone</span><span class="w"></span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#development-linting-__codelineno-8-9"></a>
<a id="__codelineno-8-10" name="__codelineno-8-10" href="#development-linting-__codelineno-8-10"></a><span class="nt">stages</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-11" name="__codelineno-8-11" href="#development-linting-__codelineno-8-11"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prepare</span><span class="w"></span>
<a id="__codelineno-8-12" name="__codelineno-8-12" href="#development-linting-__codelineno-8-12"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">syntax</span><span class="w"></span>
<a id="__codelineno-8-13" name="__codelineno-8-13" href="#development-linting-__codelineno-8-13"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lint</span><span class="w"></span>
<a id="__codelineno-8-14" name="__codelineno-8-14" href="#development-linting-__codelineno-8-14"></a>
<a id="__codelineno-8-15" name="__codelineno-8-15" href="#development-linting-__codelineno-8-15"></a><span class="nt">prepare</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-16" name="__codelineno-8-16" href="#development-linting-__codelineno-8-16"></a><span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prepare</span><span class="w"></span>
<a id="__codelineno-8-17" name="__codelineno-8-17" href="#development-linting-__codelineno-8-17"></a><span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-18" name="__codelineno-8-18" href="#development-linting-__codelineno-8-18"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">&quot;###</span><span class="nv"> </span><span class="s">Prepare</span><span class="nv"> </span><span class="s">playbook</span><span class="nv"> </span><span class="s">execution.</span><span class="nv"> </span><span class="s">###&quot;&#39;</span><span class="w"></span>
<a id="__codelineno-8-19" name="__codelineno-8-19" href="#development-linting-__codelineno-8-19"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;cp</span><span class="nv"> </span><span class="s">ansible.cfg.sample-lab</span><span class="nv"> </span><span class="s">ansible.cfg&#39;</span><span class="w"></span>
<a id="__codelineno-8-20" name="__codelineno-8-20" href="#development-linting-__codelineno-8-20"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">&quot;$VAULT_PASSWORD&quot;</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">.vault-password&#39;</span><span class="w"></span>
<a id="__codelineno-8-21" name="__codelineno-8-21" href="#development-linting-__codelineno-8-21"></a><span class="w">  </span><span class="nt">artifacts</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-22" name="__codelineno-8-22" href="#development-linting-__codelineno-8-22"></a><span class="w">    </span><span class="nt">paths</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-23" name="__codelineno-8-23" href="#development-linting-__codelineno-8-23"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.cfg</span><span class="w"></span>
<a id="__codelineno-8-24" name="__codelineno-8-24" href="#development-linting-__codelineno-8-24"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.vault-password</span><span class="w"></span>
<a id="__codelineno-8-25" name="__codelineno-8-25" href="#development-linting-__codelineno-8-25"></a><span class="w">  </span><span class="nt">cache</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-26" name="__codelineno-8-26" href="#development-linting-__codelineno-8-26"></a><span class="w">    </span><span class="nt">paths</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-27" name="__codelineno-8-27" href="#development-linting-__codelineno-8-27"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.cfg</span><span class="w"></span>
<a id="__codelineno-8-28" name="__codelineno-8-28" href="#development-linting-__codelineno-8-28"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.vault-password</span><span class="w"></span>
<a id="__codelineno-8-29" name="__codelineno-8-29" href="#development-linting-__codelineno-8-29"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-30" name="__codelineno-8-30" href="#development-linting-__codelineno-8-30"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-lint</span><span class="w"></span>
<a id="__codelineno-8-31" name="__codelineno-8-31" href="#development-linting-__codelineno-8-31"></a>
<a id="__codelineno-8-32" name="__codelineno-8-32" href="#development-linting-__codelineno-8-32"></a><span class="nt">syntax-check</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-33" name="__codelineno-8-33" href="#development-linting-__codelineno-8-33"></a><span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">syntax</span><span class="w"></span>
<a id="__codelineno-8-34" name="__codelineno-8-34" href="#development-linting-__codelineno-8-34"></a><span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-35" name="__codelineno-8-35" href="#development-linting-__codelineno-8-35"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">&quot;Perform</span><span class="nv"> </span><span class="s">a</span><span class="nv"> </span><span class="s">syntax</span><span class="nv"> </span><span class="s">check</span><span class="nv"> </span><span class="s">on</span><span class="nv"> </span><span class="s">the</span><span class="nv"> </span><span class="s">playbook.</span><span class="nv"> </span><span class="s">###&quot;&#39;</span><span class="w"></span>
<a id="__codelineno-8-36" name="__codelineno-8-36" href="#development-linting-__codelineno-8-36"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;docker</span><span class="nv"> </span><span class="s">run</span><span class="nv"> </span><span class="s">--rm</span><span class="nv"> </span><span class="s">--entrypoint</span><span class="nv"> </span><span class="s">ansible-playbook</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">$(pwd):/data</span><span class="nv"> </span><span class="s">ansible-lint</span><span class="nv"> </span><span class="s">site.yml</span><span class="nv"> </span><span class="s">--syntax-check&#39;</span><span class="w"></span>
<a id="__codelineno-8-37" name="__codelineno-8-37" href="#development-linting-__codelineno-8-37"></a><span class="w">  </span><span class="nt">cache</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-38" name="__codelineno-8-38" href="#development-linting-__codelineno-8-38"></a><span class="w">    </span><span class="nt">paths</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-39" name="__codelineno-8-39" href="#development-linting-__codelineno-8-39"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.cfg</span><span class="w"></span>
<a id="__codelineno-8-40" name="__codelineno-8-40" href="#development-linting-__codelineno-8-40"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.vault-password</span><span class="w"></span>
<a id="__codelineno-8-41" name="__codelineno-8-41" href="#development-linting-__codelineno-8-41"></a><span class="w">  </span><span class="nt">dependencies</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-42" name="__codelineno-8-42" href="#development-linting-__codelineno-8-42"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prepare</span><span class="w"></span>
<a id="__codelineno-8-43" name="__codelineno-8-43" href="#development-linting-__codelineno-8-43"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-44" name="__codelineno-8-44" href="#development-linting-__codelineno-8-44"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-lint</span><span class="w"></span>
<a id="__codelineno-8-45" name="__codelineno-8-45" href="#development-linting-__codelineno-8-45"></a>
<a id="__codelineno-8-46" name="__codelineno-8-46" href="#development-linting-__codelineno-8-46"></a><span class="nt">ansible-lint</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-47" name="__codelineno-8-47" href="#development-linting-__codelineno-8-47"></a><span class="w">  </span><span class="nt">stage</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lint</span><span class="w"></span>
<a id="__codelineno-8-48" name="__codelineno-8-48" href="#development-linting-__codelineno-8-48"></a><span class="w">  </span><span class="nt">script</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-49" name="__codelineno-8-49" href="#development-linting-__codelineno-8-49"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">&quot;###</span><span class="nv"> </span><span class="s">Check</span><span class="nv"> </span><span class="s">for</span><span class="nv"> </span><span class="s">best</span><span class="nv"> </span><span class="s">practices</span><span class="nv"> </span><span class="s">with</span><span class="nv"> </span><span class="s">ansible-lint.</span><span class="nv"> </span><span class="s">###&quot;&#39;</span><span class="w"></span>
<a id="__codelineno-8-50" name="__codelineno-8-50" href="#development-linting-__codelineno-8-50"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="s">&quot;###</span><span class="nv"> </span><span class="s">Using</span><span class="nv"> </span><span class="s">ansible-lint</span><span class="nv"> </span><span class="s">version:</span><span class="nv"> </span><span class="s">###&quot;&#39;</span><span class="w"></span>
<a id="__codelineno-8-51" name="__codelineno-8-51" href="#development-linting-__codelineno-8-51"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;docker</span><span class="nv"> </span><span class="s">run</span><span class="nv"> </span><span class="s">--rm</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">$(pwd):/data</span><span class="nv"> </span><span class="s">ansible-lint&#39;</span><span class="w"></span>
<a id="__codelineno-8-52" name="__codelineno-8-52" href="#development-linting-__codelineno-8-52"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&#39;docker</span><span class="nv"> </span><span class="s">run</span><span class="nv"> </span><span class="s">--rm</span><span class="nv"> </span><span class="s">-v</span><span class="nv"> </span><span class="s">$(pwd):/data</span><span class="nv"> </span><span class="s">ansible-lint</span><span class="nv"> </span><span class="s">site.yml&#39;</span><span class="w"></span>
<a id="__codelineno-8-53" name="__codelineno-8-53" href="#development-linting-__codelineno-8-53"></a><span class="w">  </span><span class="nt">cache</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-54" name="__codelineno-8-54" href="#development-linting-__codelineno-8-54"></a><span class="w">    </span><span class="nt">paths</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-55" name="__codelineno-8-55" href="#development-linting-__codelineno-8-55"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible.cfg</span><span class="w"></span>
<a id="__codelineno-8-56" name="__codelineno-8-56" href="#development-linting-__codelineno-8-56"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.vault-password</span><span class="w"></span>
<a id="__codelineno-8-57" name="__codelineno-8-57" href="#development-linting-__codelineno-8-57"></a><span class="w">  </span><span class="nt">dependencies</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-58" name="__codelineno-8-58" href="#development-linting-__codelineno-8-58"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prepare</span><span class="w"></span>
<a id="__codelineno-8-59" name="__codelineno-8-59" href="#development-linting-__codelineno-8-59"></a><span class="w">  </span><span class="nt">tags</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-60" name="__codelineno-8-60" href="#development-linting-__codelineno-8-60"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible-lint</span><span class="w"></span>
</code></pre></div>
<p>If you want to utilize the installed <em>ansible</em> and <em>ansible-lint</em> utilities on the host running the Gitlab Runner change the commands in the <em>syntax</em> stage to <code>ansible-playbook site.yml --syntax-check</code> and in the <em>lint</em> stage to <code>ansible-lint --version</code> and <code>ansible-lint site.yml</code>.</p></section><section class="print-page" id="development-testing"><h1 id="development-testing-testing">Testing</h1>
<p>With many people contributing to the automation, it is crucial to test the automation content in-depth. So when you’re developing new Ansible Content like playbooks, roles and collections, it’s a good idea to test the content in a test environment before using it to automate production infrastructure. Testing ensures the automation works as designed and avoids unpleasant surprises down the road.<br />
Testing automation content is often a challenge, since it requires the deployment of specific testing infrastructure as well as setting up the testing conditions to ensure the tests are relevant.</p>
<p>Consider the following list for testing your Ansible content, with increasing complexity:</p>
<ol>
<li>yamllint</li>
<li>ansible-playbook --syntax-check</li>
<li>ansible-lint</li>
<li>molecule test</li>
<li>ansible-playbook --check (<em>against production</em>)</li>
<li>Parallel infrastructure</li>
</ol>
<h2 id="development-testing-syntax-check">Syntax check</h2>
<p>The whole playbook (and all roles and tasks) need to, minimally, pass a basic ansible-playbook syntax check run.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#development-testing-__codelineno-0-1"></a>ansible-playbook main.yml --syntax-check
</code></pre></div>
<p>Running this as a step in a CI Pipeline is advisable.</p>
<h2 id="development-testing-molecule">Molecule</h2>
<p>Molecule project is designed to aid in the development and testing of Ansible roles, provides support for testing with multiple instances, operating systems and distributions, virtualization providers, test frameworks and testing scenarios.<br />
Molecule is mostly used to test roles in isolation (although it is possible to test multiple roles or playbooks at once). To test against a fresh system, molecule uses Docker to provision virtualized test hosts, run commands on them and assert the success. Molecule does not connect via ssh to the container, instead it uses an Ansible installation inside the container. It is therefor necessary to use a custom build container image. </p>
<p>Take a look at the <a href="https://molecule.readthedocs.io/en/latest/index.html#" target="_blank">Molecule documentation</a> for a full overview.</p>
<h3 id="development-testing-installation">Installation</h3>
<p>The described configuration below expects the Docker container runtime on the Ansible Controller (other drivers are available), the binary and dependencies are installed through the <em>Python package manager</em>.<br />
Use a <em>Python Virtual environment</em> (requires the <code>python3-venv</code> package) to encapsulate the installation from the rest of your Controller.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#development-testing-__codelineno-1-1"></a>python3 -m venv molecule-venv
</code></pre></div>
<p>Activate the VE:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#development-testing-__codelineno-2-1"></a><span class="nb">source</span> molecule-virtualenv/bin/activate
</code></pre></div>
<p>Install dependencies (an own Ansible is necessary, <code>ansible-lint</code> is optional, but useful):</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#development-testing-__codelineno-3-1"></a>pip3 install --upgrade pip
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#development-testing-__codelineno-3-2"></a>pip3 install ansible-core
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#development-testing-__codelineno-3-3"></a>pip3 install molecule
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#development-testing-__codelineno-3-4"></a>pip3 install molecule-docker
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#development-testing-__codelineno-3-5"></a>pip3 install ansible-lint
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Currently (21.05.2022), there is a bug when trying to login with <code>molecule login</code> command. Use version 3.5.2 of the molecule package!<br />
This is fixed in version 4.0.3, update if possible.</p>
</div>
<p>Python package <code>molecule-docker</code> requires the modules of the <em>community.docker</em> collection. When you only installed <code>ansible-core</code>, you'll need to install the collection separately:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#development-testing-__codelineno-4-1"></a>ansible-galaxy collection install community.docker
</code></pre></div>
<p>Use <code>deactivate</code> to leave your VE.</p>
<h3 id="development-testing-configuration">Configuration</h3>
<p>You may use these example configurations as a starting point. It expects that the <a href="https://hub.docker.com/r/timgrt/centos7-ansible">Docker image</a> is already present (use <code>docker pull timgrt/centos7-ansible</code>) and <code>ansible-lint</code> is installed. See the install instructions above.</p>
<p>The <em>molecule</em> configuration files are kept in the role folder you want to test. Create the directory <code>molecule/default</code> and at least the <code>molecule.yml</code> and <code>converge.yml</code>:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#development-testing-__codelineno-5-1"></a>roles/
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#development-testing-__codelineno-5-2"></a>└── webserver-demo
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#development-testing-__codelineno-5-3"></a>    ├── defaults
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#development-testing-__codelineno-5-4"></a>    │   └── main.yml
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#development-testing-__codelineno-5-5"></a><span class="hll">    ├── molecule
</span><a id="__codelineno-5-6" name="__codelineno-5-6" href="#development-testing-__codelineno-5-6"></a><span class="hll">    │   └── default
</span><a id="__codelineno-5-7" name="__codelineno-5-7" href="#development-testing-__codelineno-5-7"></a><span class="hll">    │       ├── converge.yml
</span><a id="__codelineno-5-8" name="__codelineno-5-8" href="#development-testing-__codelineno-5-8"></a><span class="hll">    │       └── molecule.yml
</span><a id="__codelineno-5-9" name="__codelineno-5-9" href="#development-testing-__codelineno-5-9"></a>    ├── tasks
<a id="__codelineno-5-10" name="__codelineno-5-10" href="#development-testing-__codelineno-5-10"></a>    │   └── main.yml
<a id="__codelineno-5-11" name="__codelineno-5-11" href="#development-testing-__codelineno-5-11"></a>    └── templates
<a id="__codelineno-5-12" name="__codelineno-5-12" href="#development-testing-__codelineno-5-12"></a>        └── index.html
</code></pre></div>
<div class="tabbed-set tabbed-alternate" data-tabs="1:4"><input checked="checked" id="development-testing-__tabbed_1_1" name="development-testing-__tabbed_1" type="radio" /><input id="development-testing-__tabbed_1_2" name="development-testing-__tabbed_1" type="radio" /><input id="development-testing-__tabbed_1_3" name="development-testing-__tabbed_1" type="radio" /><input id="development-testing-__tabbed_1_4" name="development-testing-__tabbed_1" type="radio" /><div class="tabbed-labels"><label for="development-testing-__tabbed_1_1">Central Molecule configuration</label><label for="development-testing-__tabbed_1_2">Playbook file</label><label for="development-testing-__tabbed_1_3">Preparation stage</label><label for="development-testing-__tabbed_1_4">Verification</label></div>
<div class="tabbed-content">
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">molecule.yml</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#development-testing-__codelineno-6-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-6-2" name="__codelineno-6-2" href="#development-testing-__codelineno-6-2"></a><span class="nt">driver</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-3" name="__codelineno-6-3" href="#development-testing-__codelineno-6-3"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">docker</span><span class="w"></span>
<a id="__codelineno-6-4" name="__codelineno-6-4" href="#development-testing-__codelineno-6-4"></a><span class="nt">platforms</span><span class="p">:</span><span class="w"> </span><span class="c1"># (1)!</span><span class="w"></span>
<a id="__codelineno-6-5" name="__codelineno-6-5" href="#development-testing-__codelineno-6-5"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">instance1</span><span class="w"> </span><span class="c1"># (2)!</span><span class="w"></span>
<a id="__codelineno-6-6" name="__codelineno-6-6" href="#development-testing-__codelineno-6-6"></a><span class="w">    </span><span class="nt">groups</span><span class="p">:</span><span class="w"> </span><span class="c1"># (3)!</span><span class="w"></span>
<a id="__codelineno-6-7" name="__codelineno-6-7" href="#development-testing-__codelineno-6-7"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">molecule</span><span class="w"></span>
<a id="__codelineno-6-8" name="__codelineno-6-8" href="#development-testing-__codelineno-6-8"></a><span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">timgrt/centos7-ansible:latest</span><span class="w"> </span><span class="c1"># (4)!</span><span class="w"></span>
<a id="__codelineno-6-9" name="__codelineno-6-9" href="#development-testing-__codelineno-6-9"></a><span class="w">    </span><span class="nt">tmpfs</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-10" name="__codelineno-6-10" href="#development-testing-__codelineno-6-10"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/run</span><span class="w"></span>
<a id="__codelineno-6-11" name="__codelineno-6-11" href="#development-testing-__codelineno-6-11"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/tmp</span><span class="w"></span>
<a id="__codelineno-6-12" name="__codelineno-6-12" href="#development-testing-__codelineno-6-12"></a><span class="w">    </span><span class="nt">volumes</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-13" name="__codelineno-6-13" href="#development-testing-__codelineno-6-13"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/sys/fs/cgroup:/sys/fs/cgroup:ro</span><span class="w"></span>
<a id="__codelineno-6-14" name="__codelineno-6-14" href="#development-testing-__codelineno-6-14"></a><span class="w">    </span><span class="nt">privileged</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-6-15" name="__codelineno-6-15" href="#development-testing-__codelineno-6-15"></a><span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/usr/sbin/init&quot;</span><span class="w"></span>
<a id="__codelineno-6-16" name="__codelineno-6-16" href="#development-testing-__codelineno-6-16"></a><span class="w">    </span><span class="nt">pre_build_image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># (5)!</span><span class="w"></span>
<a id="__codelineno-6-17" name="__codelineno-6-17" href="#development-testing-__codelineno-6-17"></a><span class="nt">provisioner</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-18" name="__codelineno-6-18" href="#development-testing-__codelineno-6-18"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span><span class="w"></span>
<a id="__codelineno-6-19" name="__codelineno-6-19" href="#development-testing-__codelineno-6-19"></a><span class="w">  </span><span class="nt">options</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-20" name="__codelineno-6-20" href="#development-testing-__codelineno-6-20"></a><span class="w">    </span><span class="nt">D</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"> </span><span class="c1"># (6)!</span><span class="w"></span>
<a id="__codelineno-6-21" name="__codelineno-6-21" href="#development-testing-__codelineno-6-21"></a><span class="w">  </span><span class="nt">connection_options</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-22" name="__codelineno-6-22" href="#development-testing-__codelineno-6-22"></a><span class="w">    </span><span class="nt">ansible_user</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span><span class="w"> </span><span class="c1"># (7)!</span><span class="w"></span>
<a id="__codelineno-6-23" name="__codelineno-6-23" href="#development-testing-__codelineno-6-23"></a><span class="w">  </span><span class="nt">config_options</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-24" name="__codelineno-6-24" href="#development-testing-__codelineno-6-24"></a><span class="w">    </span><span class="nt">defaults</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-25" name="__codelineno-6-25" href="#development-testing-__codelineno-6-25"></a><span class="w">      </span><span class="nt">interpreter_python</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">auto_silent</span><span class="w"></span>
<a id="__codelineno-6-26" name="__codelineno-6-26" href="#development-testing-__codelineno-6-26"></a><span class="w">      </span><span class="nt">callbacks_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">profile_tasks, timer, yaml</span><span class="w"> </span><span class="c1"># (8)!</span><span class="w"></span>
<a id="__codelineno-6-27" name="__codelineno-6-27" href="#development-testing-__codelineno-6-27"></a><span class="w">  </span><span class="nt">inventory</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-28" name="__codelineno-6-28" href="#development-testing-__codelineno-6-28"></a><span class="w">    </span><span class="nt">links</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-29" name="__codelineno-6-29" href="#development-testing-__codelineno-6-29"></a><span class="w">      </span><span class="nt">group_vars</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">../../../../inventory/group_vars/</span><span class="w"> </span><span class="c1"># (9)!</span><span class="w"></span>
<a id="__codelineno-6-30" name="__codelineno-6-30" href="#development-testing-__codelineno-6-30"></a><span class="nt">lint</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">|</span><span class="w"> </span><span class="c1"># (10)!</span><span class="w"></span>
<a id="__codelineno-6-31" name="__codelineno-6-31" href="#development-testing-__codelineno-6-31"></a><span class="w">  </span><span class="no">set -e</span><span class="w"></span>
<a id="__codelineno-6-32" name="__codelineno-6-32" href="#development-testing-__codelineno-6-32"></a><span class="w">  </span><span class="no">ansible-lint .</span><span class="w"></span>
<a id="__codelineno-6-33" name="__codelineno-6-33" href="#development-testing-__codelineno-6-33"></a><span class="nt">scenario</span><span class="p">:</span><span class="w"> </span><span class="c1"># (11)!</span><span class="w"></span>
<a id="__codelineno-6-34" name="__codelineno-6-34" href="#development-testing-__codelineno-6-34"></a><span class="w">  </span><span class="nt">create_sequence</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-35" name="__codelineno-6-35" href="#development-testing-__codelineno-6-35"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create</span><span class="w"></span>
<a id="__codelineno-6-36" name="__codelineno-6-36" href="#development-testing-__codelineno-6-36"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prepare</span><span class="w"></span>
<a id="__codelineno-6-37" name="__codelineno-6-37" href="#development-testing-__codelineno-6-37"></a><span class="w">  </span><span class="nt">converge_sequence</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-38" name="__codelineno-6-38" href="#development-testing-__codelineno-6-38"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create</span><span class="w"></span>
<a id="__codelineno-6-39" name="__codelineno-6-39" href="#development-testing-__codelineno-6-39"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">prepare</span><span class="w"></span>
<a id="__codelineno-6-40" name="__codelineno-6-40" href="#development-testing-__codelineno-6-40"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">converge</span><span class="w"></span>
<a id="__codelineno-6-41" name="__codelineno-6-41" href="#development-testing-__codelineno-6-41"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lint</span><span class="w"></span>
<a id="__codelineno-6-42" name="__codelineno-6-42" href="#development-testing-__codelineno-6-42"></a><span class="w">  </span><span class="nt">test_sequence</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-43" name="__codelineno-6-43" href="#development-testing-__codelineno-6-43"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">destroy</span><span class="w"></span>
<a id="__codelineno-6-44" name="__codelineno-6-44" href="#development-testing-__codelineno-6-44"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">create</span><span class="w"></span>
<a id="__codelineno-6-45" name="__codelineno-6-45" href="#development-testing-__codelineno-6-45"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">converge</span><span class="w"></span>
<a id="__codelineno-6-46" name="__codelineno-6-46" href="#development-testing-__codelineno-6-46"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">idempotence</span><span class="w"></span>
<a id="__codelineno-6-47" name="__codelineno-6-47" href="#development-testing-__codelineno-6-47"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lint</span><span class="w"></span>
<a id="__codelineno-6-48" name="__codelineno-6-48" href="#development-testing-__codelineno-6-48"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">destroy</span><span class="w"></span>
<a id="__codelineno-6-49" name="__codelineno-6-49" href="#development-testing-__codelineno-6-49"></a><span class="w">  </span><span class="nt">destroy_sequence</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-6-50" name="__codelineno-6-50" href="#development-testing-__codelineno-6-50"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">destroy</span><span class="w"></span>
</code></pre></div>
<ol>
<li>List of hosts to provision by <em>molecule</em>, copy the list item and use a unique name if you want to deploy multiple containers.</li>
<li>The <em>name</em> of your container, for better identification you could use e.g. <code>demo.${USER}.molecule</code> which uses your username from environment variable    substitution, showing who deployed the container for what purpose.</li>
<li>Additional <em>groups</em> the host should be part of, using a custom <code>molecule</code> group for referencing in <code>converge.yml</code>.<br />
If you want your container to inherit variables from <em>group_vars</em> (see <em>inventory.links.group_vars</em> in the <em>provisioner</em> section), add the group(s) to this list.</li>
<li>For more information regarding the used container image, see <a href="https://hub.docker.com/r/timgrt/centos7-ansible" target="_blank">https://hub.docker.com/r/timgrt/centos7-ansible</a></li>
<li>Container image must be present before running Molecule, pull it with <code>docker pull timgrt/centos7-ansible</code></li>
<li>Enables <em>diff</em> mode, set to <code>false</code> if you don't want that.</li>
<li>Uses the <em>ansible</em> user to connect to the container (defined in the container image), this way you can test with <code>become</code>. Otherwise you would connect with the <em>root</em> user, most likely this is not what you would do in production.</li>
<li>Adds a timer to every task and the overall playbook run, as well as formatting the Ansible output to YAML for better readability.<br />
Install necessary collections with <code>ansible-galaxy collection install ansible.posix community.general</code>.</li>
<li>If you want your container to inherit variables from <em>group_vars</em>, reference the location of your <em>group_vars</em> (here they are stored in the subfolder <em>inventory</em> of the project, searching begins in the scenario folder <em>defaults</em>). Delete the <em>inventory</em> key and all content if you don't need this.</li>
<li>This runs the Best-Practice checker <em>ansible-lint</em> in the <em>converge</em> and <em>test</em> sequence, must be installed separately, see <a href="#development-linting">Linting</a> for more information. </li>
<li>A scenario allows Molecule to test a role in a particular way, these are the stages when executing Molecule.<br />
For example, running <code>molecule converge</code> would create a container (if not already created), prepare it (if not already prepared), run the <em>converge</em> stage and lint the role.<br />
Remove the list items you don't need if necessary.</li>
</ol>
</div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">converge.yml</p>
<p>The <em>role</em> to test must be defined here, change <code>role-name</code> to the actual name.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#development-testing-__codelineno-7-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#development-testing-__codelineno-7-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Converge</span><span class="w"></span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#development-testing-__codelineno-7-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">molecule</span><span class="w"></span>
<a id="__codelineno-7-4" name="__codelineno-7-4" href="#development-testing-__codelineno-7-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-7-5" name="__codelineno-7-5" href="#development-testing-__codelineno-7-5"></a><span class="w">  </span><span class="nt">roles</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-7-6" name="__codelineno-7-6" href="#development-testing-__codelineno-7-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">role-name</span><span class="w"></span>
</code></pre></div>
</div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">prepare.yml</p>
<p>Adds an <strong>optional</strong> preparation stage (referenced by <code>prepare</code> in the <em>scenario</em> definition).<br />
For example, if you want to test SSH Key-Pair creation in your container (this is also used by the <em>user</em> module to create SSH keys), install the necessary packages before running the role itself. </p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#development-testing-__codelineno-8-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#development-testing-__codelineno-8-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Prepare</span><span class="w"></span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#development-testing-__codelineno-8-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">molecule</span><span class="w"></span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#development-testing-__codelineno-8-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#development-testing-__codelineno-8-5"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-6" name="__codelineno-8-6" href="#development-testing-__codelineno-8-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Install OpenSSH for ssh-keygen</span><span class="w"></span>
<a id="__codelineno-8-7" name="__codelineno-8-7" href="#development-testing-__codelineno-8-7"></a><span class="w">      </span><span class="nt">ansible.builtin.yum</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-8-8" name="__codelineno-8-8" href="#development-testing-__codelineno-8-8"></a><span class="w">        </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">openssh</span><span class="w"></span>
<a id="__codelineno-8-9" name="__codelineno-8-9" href="#development-testing-__codelineno-8-9"></a><span class="w">        </span><span class="nt">state</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">present</span><span class="w"></span>
</code></pre></div>
<p>Remember, you are using a Docker image, not every package from the distribution is installed by default to minimze the image size.</p>
</div>
</div>
<div class="tabbed-block">
<div class="admonition example">
<p class="admonition-title">verify.yml</p>
<p>Adds an <strong>optional</strong> verification stage (referenced by <code>verify</code> in the <em>scenario</em> definition). <strong>Not used in the example above.</strong></p>
<p>Add this block to your <code>molecule.yml</code> as a top-level key:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#development-testing-__codelineno-9-1"></a><span class="nt">verifier</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-9-2" name="__codelineno-9-2" href="#development-testing-__codelineno-9-2"></a><span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible</span><span class="w"></span>
</code></pre></div>
<p>The <code>verify.yml</code> contains your tests for your role.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#development-testing-__codelineno-10-1"></a><span class="nn">---</span><span class="w"></span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#development-testing-__codelineno-10-2"></a><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Verify</span><span class="w"></span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#development-testing-__codelineno-10-3"></a><span class="w">  </span><span class="nt">hosts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">molecule</span><span class="w"></span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#development-testing-__codelineno-10-4"></a><span class="w">  </span><span class="nt">become</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w"></span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#development-testing-__codelineno-10-5"></a><span class="w">  </span><span class="nt">tasks</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#development-testing-__codelineno-10-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Get service facts</span><span class="w"></span>
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#development-testing-__codelineno-10-7"></a><span class="w">      </span><span class="nt">ansible.builtin.service_facts</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#development-testing-__codelineno-10-8"></a>
<a id="__codelineno-10-9" name="__codelineno-10-9" href="#development-testing-__codelineno-10-9"></a><span class="w">    </span><span class="c1"># Service may have started, returning &#39;OK&#39; in the service module, but may have failed later.</span><span class="w"></span>
<a id="__codelineno-10-10" name="__codelineno-10-10" href="#development-testing-__codelineno-10-10"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Ensure that MariaDB is in running state</span><span class="w"></span>
<a id="__codelineno-10-11" name="__codelineno-10-11" href="#development-testing-__codelineno-10-11"></a><span class="w">      </span><span class="nt">assert</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-10-12" name="__codelineno-10-12" href="#development-testing-__codelineno-10-12"></a><span class="w">        </span><span class="nt">that</span><span class="p">:</span><span class="w"></span>
<a id="__codelineno-10-13" name="__codelineno-10-13" href="#development-testing-__codelineno-10-13"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ansible_facts[&#39;services&#39;][&#39;mariadb.service&#39;][&#39;state&#39;] == &#39;running&#39;</span><span class="w"></span>
</code></pre></div>
<p>Other <em>verifiers</em> like <em>testinfra</em> can be used.</p>
</div>
</div>
</div>
</div>
<h3 id="development-testing-usage">Usage</h3>
<p>Molecule is executed from within the role you want to test, change directory:
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#development-testing-__codelineno-11-1"></a><span class="nb">cd</span> roles/webserver-demo
</code></pre></div></p>
<p>From here, run the molecule scenario.</p>
<p>To only create the defined containers, but not run the Ansible tasks:
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#development-testing-__codelineno-12-1"></a>molecule create
</code></pre></div></p>
<p>To run the Ansible tasks of the role (if the container does not exist, it will be created):
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#development-testing-__codelineno-13-1"></a>molecule converge
</code></pre></div></p>
<p>To execute a full test circle (existing containers are deleted, re-created and Ansible tasks are executed, containers are deleted(!) afterwards):
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#development-testing-__codelineno-14-1"></a>molecule <span class="nb">test</span>
</code></pre></div></p></section><section class="print-page" id="development-extending"><h1 id="development-extending-extending-ansible">Extending Ansible</h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Work in Progress</strong> - More description necessary.</p>
</div></section><h1 class='nav-section-title-end'>Ended: Ansible Development</h1></div>





                

              </article>
            </div>
          
          
        </div>
        
          <a href="#" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            Zurück zum Seitenanfang
          </a>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; Computacenter 2022
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    <a href="https://gitlab.ccloud.ninja/tgruetzmacher/documentation-as-code" target="_blank" rel="noopener" title="Projekt im Gitlab" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="m503.5 204.6-.7-1.8-69.7-181.78c-1.4-3.57-3.9-6.59-7.2-8.64-2.4-1.55-5.1-2.515-8-2.81-2.9-.295-5.7.083-8.4 1.11-2.7 1.02-5.1 2.66-7.1 4.78-1.9 2.12-3.3 4.67-4.1 7.44l-47 144H160.8l-47.1-144c-.8-2.77-2.2-5.31-4.1-7.43-2-2.12-4.4-3.75-7.1-4.77a18.1 18.1 0 0 0-8.38-1.113 18.4 18.4 0 0 0-8.04 2.793 18.09 18.09 0 0 0-7.16 8.64L9.267 202.8l-.724 1.8a129.57 129.57 0 0 0-3.52 82c7.747 26.9 24.047 50.7 46.447 67.6l.27.2.59.4 105.97 79.5 52.6 39.7 32 24.2c3.7 1.9 8.3 4.3 13 4.3 4.7 0 9.3-2.4 13-4.3l32-24.2 52.6-39.7 106.7-79.9.3-.3c22.4-16.9 38.7-40.6 45.6-67.5 8.6-27 7.4-55.8-2.6-82z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "/", "features": ["content.code.annotate", "navigation.indexes", "navigation.instant", "navigation.sections", "navigation.top", "search.highlight", "search.suggest"], "search": "../assets/javascripts/workers/search.16e2a7d4.min.js", "translations": {"clipboard.copied": "In Zwischenablage kopiert", "clipboard.copy": "In Zwischenablage kopieren", "search.config.lang": "de", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Suche", "search.result.more.one": "1 weiteres Suchergebnis auf dieser Seite", "search.result.more.other": "# weitere Suchergebnisse auf dieser Seite", "search.result.none": "Keine Suchergebnisse", "search.result.one": "1 Suchergebnis", "search.result.other": "# Suchergebnisse", "search.result.placeholder": "Suchbegriff eingeben", "search.result.term.missing": "Es fehlt", "select.version.title": "Version ausw\u00e4hlen"}}</script>
    
    
      <script src="../assets/javascripts/bundle.d6c3db9e.min.js"></script>
      
        <script src="../js/print-site.js"></script>
      
        <script src="../assets/javascripts/extra/snow.min.js"></script>
      
        <script src="../assets/javascripts/extra/refresh-on-toggle-dark-light.js"></script>
      
        <script src="https://unpkg.com/tablesort@5.3.0/dist/tablesort.min.js"></script>
      
        <script src="../assets/javascripts/extra/tablesort.js"></script>
      
    
  </body>
</html>